<!DOCTYPE html>
<html lang="en">
<head>
    <title>Change Detection Task</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            font-size: 16px;
        }
        #container {
            margin: 10px auto;
            width: 95%;
            max-width: 800px;
        }
        h1 {
            font-size: 24px;
        }
        #stimuliArea, #noChangeTrainingArea, #changeTrainingArea {
            margin: 20px auto;
            width: 90%;
            max-width: 600px;
            height: 400px;
            border: 1px solid #ccc;
            position: relative;
            background-color: #f5f5f5;
        }
        .stimulus {
            position: absolute;
            border: 1px solid rgba(0,0,0,0.2);
        }
        #controls, #noChangeTrainingControls, #changeTrainingControls {
            margin: 20px;
        }
        button {
            padding: 12px 20px;
            font-size: 18px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #e8e8e8;
        }
        #responseYes, #responseNo, #noChangeTrainingYes, #noChangeTrainingNo, #changeTrainingYes, #changeTrainingNo {
            min-width: 150px;
            margin: 10px;
        }
        #results {
            margin: 20px;
            text-align: left;
            display: none;
            font-size: 18px;
        }
        #thankYouMessage {
            margin: 40px;
            font-size: 24px;
            display: none;
        }
        #savingMessage {
            margin: 40px;
            font-size: 24px;
        }
        .actionButton {
            margin: 10px;
            padding: 15px 25px;
            font-size: 18px;
            display: none;
        }
        #participantIdForm {
            margin: 20px;
        }
        #participantId {
            padding: 12px;
            font-size: 18px;
            width: 80%;
            max-width: 300px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #saveStatus {
            margin-top: 15px;
            font-weight: bold;
            font-size: 18px;
        }
        #debugInfo {
            margin-top: 20px;
            text-align: left;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        #buttonsContainer {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        #previousParticipationWarning, #sameIdDifferentDeviceWarning, #invalidIdLengthWarning, #connectionErrorMessage {
            color: red;
            font-weight: bold;
            margin: 20px;
            padding: 15px;
            border: 1px solid red;
            background-color: #ffeeee;
            display: none;
            font-size: 18px;
        }
        #completionCodeContainer {
            margin: 20px 0;
            padding: 15px;
            border: 2px dashed #666;
            background-color: #f9f9f9;
        }
        #completionCode {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 15px 0;
        }
        #adminButtonContainer {
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-size: 18px;
        }
        #languageToggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 8px 15px;
            border-radius: 5px;
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            cursor: pointer;
            z-index: 1000;
            font-size: 16px;
        }
        .rtl {
            direction: rtl;
            text-align: right;
        }
        .ltr {
            direction: ltr;
            text-align: left;
        }
        
		#practiceArea {
			margin: 20px auto;
			width: 90%;
			max-width: 600px;
			height: 400px;
			border: 1px solid #ccc;
			position: relative;
			background-color: #f5f5f5;
		}
		
		#practiceControls {
			margin: 20px;
		}
		
		#practiceTrialNumber {
			text-align: center;
			font-size: 18px;
			margin: 10px 0;
		}
		
		@media screen and (max-width: 768px) {
			#practiceArea {
				height: 350px;
			}
		}
		
        /* New Admin Control Panel styles */
        #controlPanelButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            display: block;
        }
        
        #adminModeIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffcc00;
            color: #000;
            padding: 5px 0;
            font-weight: bold;
            z-index: 1001;
            display: none;
        }
        
        #controlPanelModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1002;
        }
        
        .controlPanelContent {
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .controlPanelHeader {
            font-size: 22px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }
        
        .controlPanelFooter {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
        }
        
        .controlPanelSection {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .controlPanelSection h3 {
            margin-bottom: 10px;
        }
        
        .adminButton {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .adminButton.danger {
            background-color: #ffeeee;
            border-color: #ffaaaa;
            color: #cc0000;
        }
        
        .adminButton.primary {
            background-color: #e8f0ff;
            border-color: #aaccff;
            color: #0055cc;
        }
        
        .closeControlPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }
        
        .closeControlPanel:hover {
            color: #333;
        }
        
        .adminToggleSwitch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 10px;
        }
        
        .adminToggleSwitch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .adminSlider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .adminSlider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .adminSlider {
            background-color: #2196F3;
        }
        
        input:checked + .adminSlider:before {
            transform: translateX(26px);
        }
        
        .skipButton, .bypassButton {
            display: none;
            margin: 10px auto;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        
        .confirmationModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1003;
        }
        
        .confirmationContent {
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        /* Media Queries for Mobile Devices */
        @media screen and (max-width: 768px) {
            body {
                font-size: 18px;
            }
            h1 {
                font-size: 28px;
            }
            button {
                padding: 15px 25px;
                font-size: 20px;
                margin: 10px 5px;
                width: 90%;
                max-width: 350px;
            }
            #participantId {
                padding: 15px;
                font-size: 20px;
                width: 90%;
                max-width: 350px;
            }
            label {
                font-size: 20px;
                margin-bottom: 15px;
            }
            #stimuliArea, #noChangeTrainingArea, #changeTrainingArea {
                height: 350px;
            }
            #thankYouMessage, #savingMessage {
                font-size: 28px;
            }
            #previousParticipationWarning, #connectionErrorMessage, #sameIdDifferentDeviceWarning, #invalidIdLengthWarning {
                font-size: 20px;
            }
            #results {
                font-size: 20px;
            }
            #saveStatus {
                font-size: 20px;
            }
            #responseYes, #responseNo, #noChangeTrainingYes, #noChangeTrainingNo, #changeTrainingYes, #changeTrainingNo {
                min-width: 90%;
                margin: 10px auto;
            }
            #controls, #noChangeTrainingControls, #changeTrainingControls {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            #languageToggle {
                bottom: 20px;
                left: 20px;
                padding: 10px 18px;
                font-size: 18px;
            }
            #controlPanelButton {
                bottom: 70px;
                right: 10px;
                font-size: 16px;
                padding: 10px;
            }
            
            .adminToggleSwitch {
                width: 50px;
                height: 28px;
            }
            
            .adminSlider:before {
                height: 20px;
                width: 20px;
            }
            
            input:checked + .adminSlider:before {
                transform: translateX(22px);
            }
        }
		
		#timerDisplay {
            position: fixed;
            top: 30px; /* Below admin mode indicator */
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            display: none; /* Hidden by default, shown in admin mode */
            z-index: 999;
        }
        
        #timeoutMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 0, 0, 0.2);
            color: red;
            font-size: 24px;
            font-weight: bold;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid red;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="timerDisplay">00:00</div>
	
	<div id="timeoutMessage">Too slow, skipping!</div>
	
	<div id="container">
        <!-- Admin Mode Indicator -->
        <div id="adminModeIndicator">ADMIN MODE ACTIVE</div>
        
        <h1 id="pageTitle">Cognitive Task</h1>
        
        <!-- Connection error message -->
        <div id="connectionErrorMessage">
            <p id="connectionErrorText1">Unable to connect to Google Sheets.</p>
            <p id="connectionErrorText2">Please use a different WIFI or Mobile Data connection and refresh the page.</p>
            <button id="retryConnectionButton">Retry Connection</button>
        </div>
        
        <div id="previousParticipationWarning">
            <p id="prevParticipationText1">It appears you have already participated in this study.</p>
            <p id="prevParticipationText2">Each participant should only complete the study once.</p>
            <p id="prevParticipationText3">Please contact the researcher if you believe this is an error.</p>
        </div>
        
        <div id="sameIdDifferentDeviceWarning">
            <p id="sameIdText1">This Participant ID has already been used on a different device.</p>
            <p id="sameIdText2">Each participant ID can only be used on one device.</p>
            <p id="sameIdText3">Please contact the researcher if you believe this is an error.</p>
        </div>
        
        <div id="invalidIdLengthWarning">
            <p id="invalidIdText1">Invalid Participant ID length.</p>
            <p id="invalidIdText2">Participant ID must be exactly 9 characters long.</p>
            <p id="invalidIdText3">Please try again with the correct ID format.</p>
        </div>
        
        <div id="participantIdForm">
            <label for="participantId" id="participantIdLabel">Participant ID:</label>
            <input type="text" id="participantId" required>
            <button id="startExperiment">Begin Experiment</button>
            <button id="bypassIdCheckButton" class="adminButton bypassButton">Bypass ID Check</button>
        </div>
        
        <div id="instructionsPage" style="display:none;">
            <h2 id="instructionsTitle">Experiment Instructions</h2>
            <div style="margin: 20px; padding: 20px; border: 1px solid #ccc; background-color: #f9f9f9;">
                <p id="instructionsText1">Welcome to the Cognitive Task for our experiment.</p>
                <p id="instructionsText2"><strong>How it works:</strong></p>
                <ol>
                    <li id="instructionsStep1">You will briefly see several colored squares on the screen.</li>
                    <li id="instructionsStep2">The squares will disappear for a moment.</li>
                    <li id="instructionsStep3">After the squares disappear they will reappear and you need to identify whether there was a change in their position by clicking the appropriate button.</li>
                    <li id="instructionsStep4">You can press the K key (if you detect a change) or D key (if you don't detect a change) on the keyboard.</li>
                </ol>
                <p id="instructionsText3">This experiment will take a few minutes, please try to stay focused throughout the experiment.</p>
                <p id="instructionsText4">Let's begin with some practice trials to make sure you understand the task.</p>
		        <p id="instructionsText5"><strong>Important:</strong> Please respond to each trial both quickly AND accurately. If you take more than 15 seconds to respond to any trial, it will automatically skip to the next trial and count as incorrect.</p>
            </div>
            <button id="instructionsUnderstoodButton" disabled>I understand (enabled in 5 seconds)</button>
            <button id="skipInstructionsButton" class="adminButton skipButton">Skip Instructions</button>
            <div id="instructionsTimer" style="margin-top: 10px; font-style: italic;">Please read the instructions (5 seconds remaining)</div>
        </div>
        
        <div id="noChangeTrainingPage" style="display:none;">
            <h2 id="noChangeTitle">Practice Trial: No Change</h2>
            <p id="noChangeText1">In this practice, you will see an example where <strong>NO squares change position</strong>.</p>
            <p id="noChangeText2">First, several colored squares will appear. Try to remember their positions.</p>
            <p id="noChangeText3">After they disappear briefly, they will reappear in the <strong>exact same positions</strong>.</p>
            <p id="noChangeText4">When this happens, you should click the <strong>"No Change"</strong> button.</p>
            <div id="noChangeTrainingArea"></div>
            <div id="noChangeTrainingControls">
                <button id="startNoChangeTraining">Start Practice Trial</button>
                <button id="noChangeTrainingYes" disabled>Change Detected (K)</button>
                <button id="noChangeTrainingNo" disabled>No Change (D)</button>
                <button id="skipNoChangeTrainingButton" class="adminButton skipButton">Skip No-Change Training</button>
            </div>
            <div id="noChangeFeedback" style="margin-top: 20px; font-weight: bold; display: none;"></div>
        </div>
        
        <div id="changeTrainingPage" style="display:none;">
            <h2 id="changeTitle">Practice Trial: Change</h2>
            <p id="changeText1">In this practice, you will see an example where <strong>one or more squares CHANGE position</strong>.</p>
            <p id="changeText2">First, several colored squares will appear. Try to remember their positions.</p>
            <p id="changeText3">After they disappear briefly, they will reappear with <strong>at least one square in a different position</strong>.</p>
            <p id="changeText4">When this happens, you should click the <strong>"Change Detected"</strong> button.</p>
            <div id="changeTrainingArea"></div>
            <div id="changeTrainingControls">
                <button id="startChangeTraining">Start Practice Trial</button>
                <button id="changeTrainingYes" disabled>Change Detected (K)</button>
                <button id="changeTrainingNo" disabled>No Change (D)</button>
                <button id="skipChangeTrainingButton" class="adminButton skipButton">Skip Change Training</button>
            </div>
            <div id="changeFeedback" style="margin-top: 20px; font-weight: bold; display: none;"></div>
        </div>
        
		<div id="practiceTrialsPage" style="display:none;">
			<h2 id="practiceTitle">Practice Trials</h2>
			<p id="practiceText1">Now you'll complete 3 practice trials to make sure you understand the task.</p>
			<p id="practiceText2">Some squares may change position, some may not. Use your best judgment.</p>
			<p id="practiceText3">You must correctly identify all 3 trials to continue to the main experiment.</p>
			<p id="practiceText4">Remember: You have 15 seconds to respond to each trial.</p>
			<div id="practiceTrialNumber" style="font-weight: bold; margin: 10px 0;">Trial 1 of 3</div>
			<div id="practiceArea"></div>
			<div id="practiceControls">
				<button id="startPracticeTrial">Start Practice Trial</button>
				<button id="practiceYes" disabled>Change Detected (K)</button>
				<button id="practiceNo" disabled>No Change (D)</button>
				<button id="skipPracticeTrialsButton" class="adminButton skipButton">Skip Practice Trials</button>
			</div>
			<div id="practiceFeedback" style="margin-top: 20px; font-weight: bold; display: none;"></div>
		</div>
		
        <div id="experimentArea" style="display:none;">
            <div id="instructions">
                <p id="mainInstructionsText">Remember the positions of the squares. After a brief blank screen, indicate if any square changed position.</p>
            </div>
            <div id="stimuliArea"></div>
            <div id="controls">
                <button id="startButton">Start Experiment</button>
                <button id="responseYes" disabled>Change Detected (K)</button>
                <button id="responseNo" disabled>No Change (D)</button>
                <button id="skipAllTrialsButton" class="adminButton skipButton">Skip All Trials</button>
            </div>
        </div>
        
        <div id="savingMessage" style="display:none;">
            <h2 id="savingText">Saving data, please wait...</h2>
        </div>
        
        <div id="thankYouMessage" style="display:none;">
            <h2 id="thankYouText">Thanks for participating in our study.</h2>
            <div id="completionCodeContainer">
                <p id="completionCodeText1">Please copy this completion code and enter it in the Polyda page:</p>
                <p id="completionCode"></p>
                <button id="copyCodeButton">Copy to Clipboard</button>
            </div>
        </div>
        
        <div id="buttonsContainer">
            <button id="showResultsButton" class="actionButton">Show Results</button>
            <button id="showLogButton" class="actionButton">Show Log</button>
            <button id="openSpreadsheetButton" class="actionButton">Open Spreadsheet</button>
        </div>
        
        <div id="results">
            <h3 id="resultsTitle">Results:</h3>
            <p id="trialsCompletedLabel">Trials completed: <span id="trialsCompleted">0</span></p>
            <p id="correctResponsesLabel">Correct responses: <span id="correctResponses">0</span></p>
            <p id="accuracyLabel">Accuracy: <span id="accuracy">0</span>%</p>
            <div id="saveControls">
                <button id="retryButton" style="display:none;">Retry Saving Data</button>
                <div id="saveStatus"></div>
            </div>
        </div>
        
        <div id="debugInfo"></div>
    </div>
    
    <!-- Language toggle button -->
    <button id="languageToggle">English / עברית</button>
    
    <!-- Control Panel Button -->
    <button id="controlPanelButton">Control Panel</button>
    
    <!-- Control Panel Modal -->
    <div id="controlPanelModal">
        <div class="controlPanelContent">
            <span class="closeControlPanel">&times;</span>
            <div class="controlPanelHeader">Admin Control Panel</div>
            
            <div id="loginSection">
                <label for="adminPassword">Admin Password:</label>
                <input type="password" id="adminPassword" style="padding: 8px; margin: 10px 0;">
                <button id="loginButton" class="adminButton primary">Login</button>
                <div id="loginError" style="color: red; margin-top: 10px; display: none;">Incorrect password</div>
            </div>
            
            <div id="controlOptions" style="display: none;">
                <div class="controlPanelSection">
                    <h3>Admin Mode</h3>
                    <span>Enable Admin Mode:</span>
                    <label class="adminToggleSwitch">
                        <input type="checkbox" id="adminModeToggle">
                        <span class="adminSlider"></span>
                    </label>
                </div>
                
                <div class="controlPanelSection">
                    <h3>Data Management</h3>
                    <button id="clearSheetButton" class="adminButton danger">Clear Google Sheet</button>
                    <button id="clearLocalStorageButton" class="adminButton danger">Clear Previously Used IDs/Devices</button>
                </div>
                
                <div class="controlPanelSection">
                    <h3>Debug Tools</h3>
                    <button id="viewLogsButton" class="adminButton">Toggle Logs</button>
                    <button id="openSpreadsheetDirectButton" class="adminButton">Open Spreadsheet</button>
                </div>
            </div>
            
            <div class="controlPanelFooter">
                <button id="closeControlPanelButton" class="adminButton">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="confirmationModal">
        <div class="confirmationContent">
            <h3 id="confirmationTitle">Confirmation</h3>
            <p id="confirmationMessage">Are you sure?</p>
            <button id="confirmYesButton" class="adminButton danger">Yes, I'm sure</button>
            <button id="confirmNoButton" class="adminButton">Cancel</button>
        </div>
    </div>

    <script>
        // Define language dictionary
        const langDict = {
            en: {
                pageTitle: "Cognitive Task",
                
                // Connection error
                connectionErrorText1: "Unable to connect to Google Sheets.",
                connectionErrorText2: "Please use a different WIFI or Mobile Data connection and refresh the page.",
                retryConnectionButton: "Retry Connection",
                
                // Warnings
                prevParticipationText1: "It appears you have already participated in this study.",
                prevParticipationText2: "Each participant should only complete the study once.",
                prevParticipationText3: "Please contact the researcher if you believe this is an error.",
                
                sameIdText1: "This Participant ID has already been used on a different device.",
                sameIdText2: "Each participant ID can only be used on one device.",
                sameIdText3: "Please contact the researcher if you believe this is an error.",
                
                invalidIdText1: "Invalid Participant ID length.",
                invalidIdText2: "Participant ID must be exactly 9 characters long.",
                invalidIdText3: "Please try again with the correct ID format.",
                
                // Participant form
                participantIdLabel: "Participant ID:",
                startExperiment: "Begin Experiment",
                
                // Instructions page
                instructionsTitle: "Experiment Instructions",
                instructionsText1: "Welcome to the Cognitive Task for our experiment.",
                instructionsText2: "How it works:",
                instructionsStep1: "You will briefly see several colored squares on the screen.",
                instructionsStep2: "The squares will disappear for a moment.",
                instructionsStep3: "After the squares disappear they will reappear and you need to identify whether there was a change in their position by clicking the appropriate button.",
                instructionsStep4: "Instead of clicking/tapping on the buttons, if you're using a keyboard, you can press the K key if you detect a change or the D key if you don't detect a change.",
                instructionsText3: "This experiment will take a few minutes, please try to stay focused throughout the experiment.",
                instructionsText4: "Let's begin with some practice trials to make sure you understand the task.",
				instructionsText5: "Important: Please respond to each trial both quickly AND accurately. If you take more than 15 seconds to respond to any trial, it will automatically skip to the next trial and count as incorrect.",
                instructionsUnderstoodButton: "I understand",
                instructionsUnderstoodButtonDisabled: "I understand (enabled in 5 seconds)",
                instructionsTimer: "Please read the instructions",
                instructionsTimerRemaining: "Please read the instructions ({0} seconds remaining)",
                
                // No change training
                noChangeTitle: "Practice Trial: No Change",
                noChangeText1: "In this practice, you will see an example where NO squares change position.",
                noChangeText2: "First, several colored squares will appear. Try to remember their positions.",
                noChangeText3: "After they disappear briefly, they will reappear in the exact same positions.",
                noChangeText4: "When this happens, you should click the \"No Change\" button.",
                startNoChangeTraining: "Start Practice Trial",
                noChangeTrainingYes: "Change Detected (K)",
                noChangeTrainingNo: "No Change (D)",
                noChangeFeedbackCorrect: "Correct! Moving to the next practice trial...",
                noChangeFeedbackIncorrect: "Incorrect. This was a 'No Change' trial. The squares returned to the same positions. Try again in 5 seconds.",
                noChangeFeedbackRetry: "Click 'Start Practice Trial' to try again.",
                
				// Change training
                changeTitle: "Practice Trial: Change",
                changeText1: "In this practice, you will see an example where one or more squares CHANGE position.",
                changeText2: "First, several colored squares will appear. Try to remember their positions.",
                changeText3: "After they disappear briefly, they will reappear with at least one square in a different position.",
                changeText4: "When this happens, you should click the \"Change Detected\" button.",
                startChangeTraining: "Start Practice Trial",
                changeTrainingYes: "Change Detected (K)",
                changeTrainingNo: "No Change (D)",
                changeFeedbackCorrect: "Correct! Moving to the main experiment...",
                changeFeedbackIncorrect: "Incorrect. This was a 'Change' trial. At least one square moved to a new position. Try again in 5 seconds.",
                changeFeedbackRetry: "Click 'Start Practice Trial' to try again.",
				
				// Practice trials
				practiceTitle: "Practice Trials",
				practiceText1: "Now you'll complete 3 practice trials to make sure you understand the task.",
				practiceText2: "Some squares may change position, some may not. Use your best judgment.",
				practiceText3: "You must correctly identify all 3 trials to continue to the main experiment.",
				practiceText4: "Remember: You have 15 seconds to respond to each trial.",
				startPracticeTrial: "Start Practice Trial",
				practiceYes: "Change Detected (K)",
				practiceNo: "No Change (D)",
				practiceTrialNumber: "Trial {0} of 3",
				practiceFeedbackCorrect: "Correct! Moving to next trial...",
				practiceFeedbackIncorrect: "Incorrect. Try again after 5 seconds.",
				practiceFeedbackComplete: "All practice trials completed! Starting main experiment...",
				practiceFeedbackRetry: "Some trials were incorrect. Let's try all 3 again after 5 seconds.",
				skipPracticeTrialsButton: "Skip Practice Trials",
                
                // Main experiment
                mainInstructionsText: "Remember the positions of the squares. After a brief blank screen, indicate if any square changed position.",
                startButton: "Start Experiment",
                responseYes: "Change Detected (K)",
                responseNo: "No Change (D)",
                
                // Results & end screens
                savingText: "Saving data, please wait...",
                thankYouText: "Thanks for participating in our study.",
                completionCodeText1: "Please copy this completion code and enter it in the Polyda page:",
                copyCodeButton: "Copy to Clipboard",
                copyCodeButtonCopied: "Copied!",
                adminAccessButton: "Admin Access",
                showResultsButton: "Show Results",
                showLogButton: "Show Log",
                hideLogButton: "Hide Log",
                openSpreadsheetButton: "Open Spreadsheet",
                resultsTitle: "Results:",
                trialsCompletedLabel: "Trials completed:",
                correctResponsesLabel: "Correct responses:",
                accuracyLabel: "Accuracy:",
                retryButton: "Retry Saving Data",
                
                // Admin Control Panel
                controlPanelButton: "Control Panel",
                adminModeIndicator: "ADMIN MODE ACTIVE",
                controlPanelHeader: "Admin Control Panel",
                adminPassword: "Admin Password:",
                loginButton: "Login",
                loginError: "Incorrect password",
                adminModeToggle: "Enable Admin Mode:",
                clearSheetButton: "Clear Google Sheet",
                clearLocalStorageButton: "Clear Previously Used IDs/Devices",
                viewLogsButton: "Toggle Logs",
                openSpreadsheetDirectButton: "Open Spreadsheet",
                closeControlPanelButton: "Close",
                confirmationTitle: "Confirmation",
                confirmYesButton: "Yes, I'm sure",
                confirmNoButton: "Cancel",
                
                // Skip buttons
                skipInstructionsButton: "Skip Instructions",
                skipNoChangeTrainingButton: "Skip No-Change Training",
                skipChangeTrainingButton: "Skip Change Training",
                skipAllTrialsButton: "Skip All Trials",
                bypassIdCheckButton: "Bypass ID Check",
                
                // Confirmation messages
                clearSheetConfirmTitle: "Clear Google Sheet?",
                clearSheetConfirmMessage: "This will remove ALL data from the Google Sheet. This action cannot be undone!",
                clearLocalStorageConfirmTitle: "Clear Local Storage?",
                clearLocalStorageConfirmMessage: "This will remove all stored participant IDs and device IDs, allowing them to be reused.",
                
                // Action confirmations
                sheetCleared: "Google Sheet cleared successfully!",
                localStorageCleared: "Local storage cleared. All participant and device IDs have been removed.",
				
				// Timer stuff
				timeoutMessage: "Too slow, skipping!",
                timerDisplay: "Time: ",
                
                // Admin overrides
                adminOverride: "Override (Admin Only)"
            },
            he: {
                pageTitle: "משימה קוגניטיבית",
                
                // Connection error
                connectionErrorText1: "לא ניתן להתחבר ל-Google Sheets.",
                connectionErrorText2: "אנא השתמש/י בחיבור WiFi אחר ורענן/י את הדף.",
                retryConnectionButton: "נסה חיבור מחדש",
                
                // Warnings
                prevParticipationText1: "נראה שכבר השתתפת במחקר זה.",
                prevParticipationText2: "כל משתתף יכול להשלים את המחקר פעם אחת בלבד.",
                prevParticipationText3: "אנא צור/י קשר עם החוקר אם את/ה סבור/ה שזו טעות.",
                
                sameIdText1: "מספר תעודת זהות זה כבר נמצא בשימוש במכשיר אחר.",
                sameIdText2: "כל מספר תעודת זהות יכול לשמש במכשיר אחד בלבד.",
                sameIdText3: "אנא צור/י קשר עם החוקר אם את/ה סבור/ה שזו טעות.",
                
                invalidIdText1: "אורך מספר תעודת זהות אינו תקין.",
                invalidIdText2: "מספר תעודת זהות חייב להיות באורך של 9 תווים בדיוק.",
                invalidIdText3: "אנא נסה/י שוב עם תבנית מזהה נכונה.",
                
                // Participant form
                participantIdLabel: "מספר תעודת זהות:",
                startExperiment: "התחל ניסוי",
                
                // Instructions page
                instructionsTitle: "הוראות הניסוי",
                instructionsText1: "ברוכים/ברוכות הבאים למשימה הקוגניטיבית של הניסוי שלנו.",
                instructionsText2: "כיצד זה עובד:",
                instructionsStep1: "תראה/י מספר ריבועים צבעוניים על המסך לזמן קצר.",
                instructionsStep2: "הריבועים ייעלמו לרגע.",
                instructionsStep3: "לאחר שהריבועים ייעלמו הם יחזרו ועלייך לזהות האם היה שינוי במיקומם בלחיצה על הכפתור המתאים.",
                instructionsStep4: "במקום ללחוץ על הכפתורים, אם אתם משתמשים במקלדת, תוכלו ללחוץ על הקש K אם אתם מזהים שינוי או על הקש D אם אתם לא מזהים שינוי.",
                instructionsText3: "הניסוי יקח רק מספר דקות, אנא נסה/י להישאר ממוקד/ת לאורך כל הניסוי.", 
                instructionsText4: "כדי לוודא שאת/ה מבינ/ה את המשימה נעשה כעת אימון ניסיון.",
			    instructionsText5: "חשוב: אנא השב/י לכל ניסיון במהירות ובדיוק. אם תיקח/י יותר מ-15 שניות להשיב לניסיון כלשהו, הוא יעבור אוטומטית לניסיון הבא וייחשב כתשובה שגויה.",
                instructionsUnderstoodButton: "אני מבין/ה",
                instructionsUnderstoodButtonDisabled: "אני מבין/ה (יופעל בעוד 5 שניות)",
                instructionsTimer: "אנא קרא/י את ההוראות",
                instructionsTimerRemaining: "אנא קרא/י את ההוראות ({0} שניות נותרו)",
                
                // No change training
                noChangeTitle: "ניסיון אימון: ללא שינוי",
                noChangeText1: "באימון זה, תראה/י דוגמה שבה ריבועים לא משנים את מיקומם.",
                noChangeText2: "תחילה, יופיעו מספר ריבועים צבעוניים. נסה/י לזכור את מיקומם.",
                noChangeText3: "לאחר שייעלמו לרגע, הם יופיעו מחדש באותם מיקומים בדיוק.",
                noChangeText4: "כשזה קורה, עליך ללחוץ על כפתור \"אין שינוי\".",
                startNoChangeTraining: "התחל ניסיון אימון",
                noChangeTrainingYes: "שינוי זוהה (K)",
                noChangeTrainingNo: "אין שינוי (D)",
                noChangeFeedbackCorrect: "נכון! עובר/ת לניסיון האימון הבא...",
                noChangeFeedbackIncorrect: "לא נכון. זה היה ניסיון 'ללא שינוי'. הריבועים חזרו לאותם מיקומים. נסה/י שוב בעוד 5 שניות.",
                noChangeFeedbackRetry: "לחץ/י על 'התחל ניסיון אימון' כדי לנסות שוב.",
                
                // Change training
                changeTitle: "ניסיון אימון: שינוי",
                changeText1: "באימון זה, תראה/י דוגמה שבה ריבוע אחד או יותר משנה מיקום.",
                changeText2: "תחילה, יופיעו מספר ריבועים צבעוניים. נסה/י לזכור את מיקומם.",
                changeText3: "לאחר שייעלמו לרגע, הם יופיעו מחדש כשלפחות ריבוע אחד במיקום שונה.",
                changeText4: "כשזה קורה, עליך ללחוץ על כפתור \"שינוי זוהה\".",
                startChangeTraining: "התחל ניסיון אימון",
                changeTrainingYes: "שינוי זוהה (K)",
                changeTrainingNo: "אין שינוי (D)",
                changeFeedbackCorrect: "נכון! עובר/ת לניסוי העיקרי...",
                changeFeedbackIncorrect: "לא נכון. זה היה ניסיון 'שינוי'. לפחות ריבוע אחד זז למיקום חדש. נסה/י שוב בעוד 5 שניות.",
                changeFeedbackRetry: "לחץ/י על 'התחל ניסיון אימון' כדי לנסות שוב.",
                
				// Practice trials
				practiceTitle: "ניסיונות אימון",
				practiceText1: "כעת תשלים/י 3 ניסיונות אימון כדי לוודא שאת/ה מבין/ה את המשימה.",
				practiceText2: "חלק מהריבועים עלולים לשנות מיקום, חלקם לא. השתמש/י בשיקול הדעת שלך.",
				practiceText3: "עליך לזהות נכון את כל 3 הניסיונות כדי להמשיך לניסוי העיקרי.",
				practiceText4: "זכור/י: יש לך 15 שניות להגיב לכל ניסיון.",
				startPracticeTrial: "התחל ניסיון אימון",
				practiceYes: "שינוי זוהה (K)",
				practiceNo: "אין שינוי (D)",
				practiceTrialNumber: "ניסיון {0} מתוך 3",
				practiceFeedbackCorrect: "נכון! עובר/ת לניסיון הבא...",
				practiceFeedbackIncorrect: "לא נכון. נסה/י שוב בעוד 5 שניות.",
				practiceFeedbackComplete: "כל ניסיונות האימון הושלמו! מתחיל/ה את הניסוי העיקרי...",
				practiceFeedbackRetry: "חלק מהניסיונות היו שגויים. ננסה את כל 3 הניסיונות שוב בעוד 5 שניות.",
				skipPracticeTrialsButton: "דלג על ניסיונות אימון",
				
                // Main experiment
                mainInstructionsText: "זכור/זכרי את מיקומי הריבועים. לאחר מסך ריק קצר, ציין/י אם ריבוע כלשהו שינה מיקום.",
                startButton: "התחל ניסוי",
                responseYes: "שינוי זוהה (K)",
                responseNo: "אין שינוי (D)",
                
                // Results & end screens
                savingText: "שומר נתונים, אנא המתן/י...",
                thankYouText: "תודה על השתתפותך במחקר שלנו.",
                completionCodeText1: "אנא העתק/י את קוד הסיום הזה והזן/י אותו בדף Polyda:",
                copyCodeButton: "העתק ללוח",
                copyCodeButtonCopied: "הועתק!",
                adminAccessButton: "גישת מנהל",
                showResultsButton: "הצג תוצאות",
                showLogButton: "הצג יומן",
                hideLogButton: "הסתר יומן",
                openSpreadsheetButton: "פתח גיליון נתונים",
                resultsTitle: "תוצאות:",
                trialsCompletedLabel: "ניסיונות שהושלמו:",
                correctResponsesLabel: "תשובות נכונות:",
                accuracyLabel: "דיוק:",
                retryButton: "נסה לשמור נתונים שוב",
                
                // Admin Control Panel
                controlPanelButton: "לוח בקרה",
                adminModeIndicator: "מצב מנהל פעיל",
                controlPanelHeader: "לוח בקרת מנהל",
                adminPassword: "סיסמת מנהל:",
                loginButton: "כניסה",
                loginError: "סיסמה שגויה",
                adminModeToggle: "הפעל מצב מנהל:",
                clearSheetButton: "נקה גיליון Google",
                clearLocalStorageButton: "נקה מזהים שנעשה בהם שימוש",
                viewLogsButton: "הצג/הסתר יומן",
                openSpreadsheetDirectButton: "פתח גיליון נתונים",
                closeControlPanelButton: "סגור",
                confirmationTitle: "אישור",
                confirmYesButton: "כן, אני בטוח/ה",
                confirmNoButton: "ביטול",
                
                // Skip buttons
                skipInstructionsButton: "דלג על ההוראות",
                skipNoChangeTrainingButton: "דלג על אימון ללא שינוי",
                skipChangeTrainingButton: "דלג על אימון שינוי",
                skipAllTrialsButton: "דלג על כל הניסיונות",
                bypassIdCheckButton: "עקוף בדיקת מזהה",
                
                // Confirmation messages
                clearSheetConfirmTitle: "לנקות את גיליון Google?",
                clearSheetConfirmMessage: "פעולה זו תסיר את כל הנתונים מגיליון Google. לא ניתן לבטל פעולה זו!",
                clearLocalStorageConfirmTitle: "לנקות את האחסון המקומי?",
                clearLocalStorageConfirmMessage: "פעולה זו תסיר את כל מזהי המשתתפים והמכשירים המאוחסנים, ותאפשר להשתמש בהם מחדש.",
                
                // Action confirmations
                sheetCleared: "גיליון Google נוקה בהצלחה!",
                localStorageCleared: "האחסון המקומי נוקה. כל מזהי המשתתפים והמכשירים הוסרו.",
				
				// Timer stuff
				timeoutMessage: "איטי מדי, מדלג!",
                timerDisplay: "זמן: ",
                
                // Admin overrides
                adminOverride: "עקיפה (מנהל בלבד)"
            }
        };
        
        // Current language
        let currentLang = "he";
        
        // Function to update all text based on current language
        function updateLanguage() {
            // Set document direction based on language
            document.body.dir = currentLang === "he" ? "rtl" : "ltr";
			
			// Hide Control Panel button when language is Hebrew
			controlPanelButton.style.display = currentLang === "he" ? "none" : "block";
            
			// Update timeout message
            timeoutMessage.textContent = langDict[currentLang].timeoutMessage;
            
            // Update timer display label
            if (timerDisplay.textContent.includes(":")) {
                const time = timerDisplay.textContent.split(": ")[1];
                timerDisplay.textContent = langDict[currentLang].timerDisplay + time;
            } else {
                timerDisplay.textContent = langDict[currentLang].timerDisplay + "00:00";
            }
			
            // Helper function to update element text
            function updateText(id, textKey) {
                const element = document.getElementById(id);
                if (element && langDict[currentLang][textKey]) {
                    element.textContent = langDict[currentLang][textKey];
                }
            }
            
            // Helper function to update element placeholder
            function updatePlaceholder(id, textKey) {
                const element = document.getElementById(id);
                if (element && langDict[currentLang][textKey]) {
                    element.placeholder = langDict[currentLang][textKey];
                }
            }
            
            // Update all text elements
            updateText("pageTitle", "pageTitle");
            
            // Connection error
            updateText("connectionErrorText1", "connectionErrorText1");
            updateText("connectionErrorText2", "connectionErrorText2");
            updateText("retryConnectionButton", "retryConnectionButton");
            
            // Warnings
            updateText("prevParticipationText1", "prevParticipationText1");
            updateText("prevParticipationText2", "prevParticipationText2");
            updateText("prevParticipationText3", "prevParticipationText3");
            
            updateText("sameIdText1", "sameIdText1");
            updateText("sameIdText2", "sameIdText2");
            updateText("sameIdText3", "sameIdText3");
            
            updateText("invalidIdText1", "invalidIdText1");
            updateText("invalidIdText2", "invalidIdText2");
            updateText("invalidIdText3", "invalidIdText3");
            
            // Participant form
            updateText("participantIdLabel", "participantIdLabel");
            updateText("startExperiment", "startExperiment");
            
            // Instructions page
            updateText("instructionsTitle", "instructionsTitle");
            updateText("instructionsText1", "instructionsText1");
            updateText("instructionsText2", "instructionsText2");
            updateText("instructionsStep1", "instructionsStep1");
            updateText("instructionsStep2", "instructionsStep2");
            updateText("instructionsStep3", "instructionsStep3");
            updateText("instructionsStep4", "instructionsStep4");
            updateText("instructionsText3", "instructionsText3");
            updateText("instructionsText4", "instructionsText4");
			updateText("instructionsText5", "instructionsText5");
            
            // Update the instructions button text based on whether it's disabled
            const instructionsButton = document.getElementById("instructionsUnderstoodButton");
            if (instructionsButton) {
                updateText("instructionsUnderstoodButton", instructionsButton.disabled ? 
                    "instructionsUnderstoodButtonDisabled" : "instructionsUnderstoodButton");
            }
            
            // No change training
            updateText("noChangeTitle", "noChangeTitle");
            updateText("noChangeText1", "noChangeText1");
            updateText("noChangeText2", "noChangeText2");
            updateText("noChangeText3", "noChangeText3");
            updateText("noChangeText4", "noChangeText4");
            updateText("startNoChangeTraining", "startNoChangeTraining");
            updateText("noChangeTrainingYes", "noChangeTrainingYes");
            updateText("noChangeTrainingNo", "noChangeTrainingNo");
            
            // Change training
            updateText("changeTitle", "changeTitle");
            updateText("changeText1", "changeText1");
            updateText("changeText2", "changeText2");
            updateText("changeText3", "changeText3");
            updateText("changeText4", "changeText4");
            updateText("startChangeTraining", "startChangeTraining");
            updateText("changeTrainingYes", "changeTrainingYes");
            updateText("changeTrainingNo", "changeTrainingNo");
            
			// Add these to the updateLanguage function:
			updateText("practiceTitle", "practiceTitle");
			updateText("practiceText1", "practiceText1");
			updateText("practiceText2", "practiceText2");
			updateText("practiceText3", "practiceText3");
			updateText("practiceText4", "practiceText4");
			updateText("startPracticeTrial", "startPracticeTrial");
			updateText("practiceYes", "practiceYes");
			updateText("practiceNo", "practiceNo");
			updateText("skipPracticeTrialsButton", "skipPracticeTrialsButton");
			
            // Main experiment
            updateText("mainInstructionsText", "mainInstructionsText");
            updateText("startButton", "startButton");
            updateText("responseYes", "responseYes");
            updateText("responseNo", "responseNo");
            
            // Results & end screens
            updateText("savingText", "savingText");
            updateText("thankYouText", "thankYouText");
            updateText("completionCodeText1", "completionCodeText1");
            updateText("copyCodeButton", "copyCodeButton");
            updateText("showResultsButton", "showResultsButton");
            
            // Show/Hide Log button text depends on current state
            const logButton = document.getElementById("showLogButton");
            if (logButton) {
                if (logButton.textContent.includes("Hide")) {
                    updateText("showLogButton", "hideLogButton");
                } else {
                    updateText("showLogButton", "showLogButton");
                }
            }
            
            updateText("openSpreadsheetButton", "openSpreadsheetButton");
            updateText("resultsTitle", "resultsTitle");
            updateText("trialsCompletedLabel", "trialsCompletedLabel");
            updateText("correctResponsesLabel", "correctResponsesLabel");
            updateText("accuracyLabel", "accuracyLabel");
            updateText("retryButton", "retryButton");
            
            // Admin control panel
            updateText("controlPanelButton", "controlPanelButton");
            updateText("adminModeIndicator", "adminModeIndicator");
            document.querySelector('.controlPanelHeader').textContent = langDict[currentLang].controlPanelHeader;
            updateText("loginButton", "loginButton");
            updateText("loginError", "loginError");
            
            const adminPasswordLabel = document.querySelector('#loginSection label');
            if (adminPasswordLabel) {
                adminPasswordLabel.textContent = langDict[currentLang].adminPassword;
            }
            
            const adminModeToggleLabel = document.querySelector('.controlPanelSection span');
            if (adminModeToggleLabel) {
                adminModeToggleLabel.textContent = langDict[currentLang].adminModeToggle;
            }
            
            updateText("clearSheetButton", "clearSheetButton");
            updateText("clearLocalStorageButton", "clearLocalStorageButton");
            updateText("viewLogsButton", "viewLogsButton");
            updateText("openSpreadsheetDirectButton", "openSpreadsheetDirectButton");
            updateText("closeControlPanelButton", "closeControlPanelButton");
            
            // Skip buttons
            updateText("skipInstructionsButton", "skipInstructionsButton");
            updateText("skipNoChangeTrainingButton", "skipNoChangeTrainingButton");
            updateText("skipChangeTrainingButton", "skipChangeTrainingButton");
            updateText("skipAllTrialsButton", "skipAllTrialsButton");
            updateText("bypassIdCheckButton", "bypassIdCheckButton");
            
            // Confirmation modal
            updateText("confirmationTitle", "confirmationTitle");
            updateText("confirmYesButton", "confirmYesButton");
            updateText("confirmNoButton", "confirmNoButton");
            
            // Update the language toggle button
            document.getElementById("languageToggle").textContent = currentLang === "en" ? "English / עברית" : "עברית / English";
            
            // Apply RTL/LTR classes to specific elements that need alignment
            const textAlignElements = document.querySelectorAll("#instructionsPage div, #results, #noChangeTrainingPage p, #changeTrainingPage p");
            textAlignElements.forEach(element => {
                if (currentLang === "he") {
                    element.classList.add("rtl");
                    element.classList.remove("ltr");
                } else {
                    element.classList.add("ltr");
                    element.classList.remove("rtl");
                }
            });
        }
        
        // Event listener for language toggle button
        document.getElementById("languageToggle").addEventListener("click", function() {
            currentLang = currentLang === "en" ? "he" : "en";
            updateLanguage();
            log('Language changed to: ' + (currentLang === "en" ? "English" : "Hebrew"));
        });

        // DOM elements
        const participantIdForm = document.getElementById('participantIdForm');
        const experimentArea = document.getElementById('experimentArea');
        const startExperimentButton = document.getElementById('startExperiment');
        const participantIdInput = document.getElementById('participantId');
        const stimuliArea = document.getElementById('stimuliArea');
        const startButton = document.getElementById('startButton');
        const responseYes = document.getElementById('responseYes');
        const responseNo = document.getElementById('responseNo');
        const resultsDiv = document.getElementById('results');
        const thankYouMessage = document.getElementById('thankYouMessage');
        const savingMessage = document.getElementById('savingMessage');
        const showResultsButton = document.getElementById('showResultsButton');
        const showLogButton = document.getElementById('showLogButton');
        const openSpreadsheetButton = document.getElementById('openSpreadsheetButton');
        const instructionsDiv = document.getElementById('instructions');
        const controlsDiv = document.getElementById('controls');
        const retryButton = document.getElementById('retryButton');
        const saveStatus = document.getElementById('saveStatus');
        const debugInfo = document.getElementById('debugInfo');
        const previousParticipationWarning = document.getElementById('previousParticipationWarning');
        const sameIdDifferentDeviceWarning = document.getElementById('sameIdDifferentDeviceWarning');
        const invalidIdLengthWarning = document.getElementById('invalidIdLengthWarning');
        const connectionErrorMessage = document.getElementById('connectionErrorMessage');
        const retryConnectionButton = document.getElementById('retryConnectionButton');
        const completionCodeElement = document.getElementById('completionCode');
        const copyCodeButton = document.getElementById('copyCodeButton');
		
		// Practice trials elements
		const practiceTrialsPage = document.getElementById('practiceTrialsPage');
		const practiceArea = document.getElementById('practiceArea');
		const practiceControls = document.getElementById('practiceControls');
		const startPracticeTrial = document.getElementById('startPracticeTrial');
		const practiceYes = document.getElementById('practiceYes');
		const practiceNo = document.getElementById('practiceNo');
		const practiceFeedback = document.getElementById('practiceFeedback');
		const practiceTrialNumber = document.getElementById('practiceTrialNumber');
		const skipPracticeTrialsButton = document.getElementById('skipPracticeTrialsButton');
        
        // New instruction pages elements
        const instructionsPage = document.getElementById('instructionsPage');
        const instructionsUnderstoodButton = document.getElementById('instructionsUnderstoodButton');
        const instructionsTimer = document.getElementById('instructionsTimer');
        const noChangeTrainingPage = document.getElementById('noChangeTrainingPage');
        const noChangeTrainingArea = document.getElementById('noChangeTrainingArea');
        const noChangeTrainingControls = document.getElementById('noChangeTrainingControls');
        const startNoChangeTraining = document.getElementById('startNoChangeTraining');
        const noChangeTrainingYes = document.getElementById('noChangeTrainingYes');
        const noChangeTrainingNo = document.getElementById('noChangeTrainingNo');
        const noChangeFeedback = document.getElementById('noChangeFeedback');
        const changeTrainingPage = document.getElementById('changeTrainingPage');
        const changeTrainingArea = document.getElementById('changeTrainingArea');
        const changeTrainingControls = document.getElementById('changeTrainingControls');
        const startChangeTraining = document.getElementById('startChangeTraining');
        const changeTrainingYes = document.getElementById('changeTrainingYes');
        const changeTrainingNo = document.getElementById('changeTrainingNo');
        const changeFeedback = document.getElementById('changeFeedback');
        
        // Admin elements
        const adminModeIndicator = document.getElementById('adminModeIndicator');
        const controlPanelButton = document.getElementById('controlPanelButton');
        const controlPanelModal = document.getElementById('controlPanelModal');
        const closeControlPanelButton = document.getElementById('closeControlPanelButton');
        const closeControlPanelX = document.querySelector('.closeControlPanel');
        const adminModeToggle = document.getElementById('adminModeToggle');
        const loginSection = document.getElementById('loginSection');
        const controlOptions = document.getElementById('controlOptions');
        const adminPassword = document.getElementById('adminPassword');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const clearSheetButton = document.getElementById('clearSheetButton');
        const clearLocalStorageButton = document.getElementById('clearLocalStorageButton');
        const viewLogsButton = document.getElementById('viewLogsButton');
        const openSpreadsheetDirectButton = document.getElementById('openSpreadsheetDirectButton');
        
        // Skip buttons
        const skipInstructionsButton = document.getElementById('skipInstructionsButton');
        const skipNoChangeTrainingButton = document.getElementById('skipNoChangeTrainingButton');
        const skipChangeTrainingButton = document.getElementById('skipChangeTrainingButton');
        const skipAllTrialsButton = document.getElementById('skipAllTrialsButton');
        const bypassIdCheckButton = document.getElementById('bypassIdCheckButton');
        
        // Confirmation modal
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmYesButton = document.getElementById('confirmYesButton');
        const confirmNoButton = document.getElementById('confirmNoButton');

        // Google Apps Script webapp URL - UPDATED
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbl7x9bHih2MCnyF70hM0APpTyFUL5JDjmXFaBNz97ExDIF_CpESGk5Z2tolEJUDM_1A/exec';
        
        // Spreadsheet URL
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1-jEKZo_zAfuIUd7rox2DW6vDLL2PB-3jShe3w5ktczU/edit#gid=0';
        
        // Admin password
        const ADMIN_PASSWORD = '25032000';
        
        // Participant ID
        let participantId = '';
        
        // Device ID - generate a unique ID for this device
        let deviceId = '';
        
        // Internet connection test status
        let isInternetConnected = false;
        
        // Completion code
        let completionCode = '';
        
        // Admin state
        let isAdminAuthenticated = false;
        let isAdminModeActive = false;
        
        // Is this a mobile device?
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // Configuration
        const config = {
            numTrials: 10, // Updated from 10 to 25
            numStimuli: 5, // Increased from 4 to 5
            stimulusSize: isMobile ? 50 : 40, // Larger squares on mobile
            studyTime: 500,
            blankTime: 900,
            changeProb: 0.5,
            maxPos: 0.8,
			responseTimeLimit: 15000, // 15 seconds in milliseconds
            // Movement parameters
            minMoveDistance: function() { return this.stimulusSize / 2; }, // Minimum movement: half a square width
            maxMoveDistance: function() { return this.stimulusSize * 2; }, // Maximum movement: two square widths
            minObjectsToMove: 1,
            maxObjectsToMove: 3,
            swapProbability: 0.3 // 30% chance objects will swap positions instead of moving randomly
        };

        // Array of contrasting colors for stimuli
        const stimuliColors = [
            '#FF0000', // Red
            '#00FF00', // Green
            '#0000FF', // Blue
            '#FFFF00', // Yellow
            '#FF00FF', // Magenta
            '#00FFFF', // Cyan
            '#FF8000', // Orange
            '#8000FF'  // Purple
        ];

        // Experiment state
        let state = {
            currentTrial: 0,
            correctResponses: 0,
            stimuliPositions: [],
            hasChange: false,
            isRunning: false,
            dataSaved: false,
            sameIdDifferentDevice: false,
            stimuliColorIndices: [],
			practiceTrials: [],
			currentPracticeTrial: 0,
			practiceCorrect: 0,
			practiceAttempt: 0,
			isPracticeRunning: false,
            responseTimes: [], // Array to store response times for each trial
            timeoutTrials: [], // Array to track which trials timed out
            trialStartTime: 0, // Timestamp when the trial starts
            trialTimeout: null // Reference to the timeout
        };
        
		// Timer stuff
		const timerDisplay = document.getElementById('timerDisplay');
        const timeoutMessage = document.getElementById('timeoutMessage');
		
        // Function to get random indices (used for selecting which objects to move)
        function getRandomIndices(max, count) {
            const indices = [];
            const available = Array.from({ length: max }, (_, i) => i);
            
            // Shuffle the array using Fisher-Yates algorithm
            for (let i = available.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [available[i], available[j]] = [available[j], available[i]];
            }
            
            // Take the first 'count' elements
            return available.slice(0, count);
        }
        
        // Function to randomize colors for each trial
        function randomizeColors() {
            // Create a copy of the stimuli colors array
            const availableColors = [...stimuliColors];
            
            // Shuffle the colors
            for (let i = availableColors.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableColors[i], availableColors[j]] = [availableColors[j], availableColors[i]];
            }
            
            // Assign unique colors to each stimulus
            state.stimuliColorIndices = [];
            for (let i = 0; i < config.numStimuli; i++) {
                // Make sure we don't go beyond available colors
                state.stimuliColorIndices.push(i % availableColors.length);
            }
            
            log(`Assigned colors for trial: ${state.stimuliColorIndices.map(i => availableColors[i]).join(', ')}`);
        }
        
        // Initialize admin controls
        function initAdminControls() {
            // Check if admin mode is stored in session
            const storedAdminState = localStorage.getItem('changeDetectionAdminMode');
            if (storedAdminState === 'true') {
                isAdminAuthenticated = true;
                toggleControlOptions(true);
            }
            
            // Check if admin mode is active
            const storedAdminModeActive = localStorage.getItem('changeDetectionAdminModeActive');
            if (storedAdminModeActive === 'true') {
                isAdminModeActive = true;
                adminModeToggle.checked = true;
                adminModeIndicator.style.display = 'block';
                updateAdminUI();
            }
            
            // Setup event listeners
            controlPanelButton.addEventListener('click', openControlPanel);
            closeControlPanelButton.addEventListener('click', closeControlPanel);
            closeControlPanelX.addEventListener('click', closeControlPanel);
            
            loginButton.addEventListener('click', attemptAdminLogin);
            adminPassword.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    attemptAdminLogin();
                }
            });
            
            // Admin mode toggle
            adminModeToggle.addEventListener('change', function() {
                isAdminModeActive = this.checked;
                localStorage.setItem('changeDetectionAdminModeActive', isAdminModeActive);
                adminModeIndicator.style.display = isAdminModeActive ? 'block' : 'none';
                updateAdminUI();
                
                log('Admin mode ' + (isAdminModeActive ? 'activated' : 'deactivated'));
            });
            
            // Data management buttons
            clearSheetButton.addEventListener('click', function() {
                showConfirmation(
                    langDict[currentLang].clearSheetConfirmTitle, 
                    langDict[currentLang].clearSheetConfirmMessage,
                    clearGoogleSheet
                );
            });
            
            clearLocalStorageButton.addEventListener('click', function() {
                showConfirmation(
                    langDict[currentLang].clearLocalStorageConfirmTitle,
                    langDict[currentLang].clearLocalStorageConfirmMessage,
                    clearLocalStorage
                );
            });
            
            // Debug tools
            viewLogsButton.addEventListener('click', toggleLogs);
            openSpreadsheetDirectButton.addEventListener('click', function() {
                window.open(SPREADSHEET_URL, '_blank');
            });
            
            // Confirmation modal
            confirmNoButton.addEventListener('click', closeConfirmation);
            
            // Skip buttons
            skipInstructionsButton.addEventListener('click', function() {
                log('Admin: Skipped instructions');
                instructionsPage.style.display = 'none';
                noChangeTrainingPage.style.display = 'block';
            });
            
            skipNoChangeTrainingButton.addEventListener('click', function() {
                log('Admin: Skipped no-change training');
                noChangeTrainingPage.style.display = 'none';
                changeTrainingPage.style.display = 'block';
            });
            
            skipChangeTrainingButton.addEventListener('click', function() {
                log('Admin: Skipped change training');
                changeTrainingPage.style.display = 'none';
                experimentArea.style.display = 'block';
                initExperiment();
            });
            
			skipAllTrialsButton.addEventListener('click', function() {
    			log('Admin: Skipped all trials');
			    
    			// Clean up any running timers
    			cleanupTimers();
			    
    			state.currentTrial = config.numTrials;
    			state.correctResponses = config.numTrials; // All correct for admin skip
			    
    			// Fill in placeholder response times for skipped trials
    			state.responseTimes = Array(config.numTrials).fill(0.5); // 0.5 seconds as a placeholder
    			state.timeoutTrials = []; // No timeouts in admin skip
			    
    			experimentComplete();
			});
			
			// Properly place the skipPracticeTrialsButton event listener outside
			skipPracticeTrialsButton.addEventListener('click', function() {
    			log('Admin: Skipped practice trials');
    			practiceTrialsPage.style.display = 'none';
    			experimentArea.style.display = 'block';
    			initExperiment();
			});
			            
            bypassIdCheckButton.addEventListener('click', function() {
                log('Admin: Bypassed ID check');
                previousParticipationWarning.style.display = 'none';
                sameIdDifferentDeviceWarning.style.display = 'none';
                invalidIdLengthWarning.style.display = 'none';
                startInstructionSequence();
            });
            
            updateAdminUI();
        }
        
        // Open and close the control panel
        function openControlPanel() {
            controlPanelModal.style.display = 'block';
        }
        
        function closeControlPanel() {
            controlPanelModal.style.display = 'none';
        }
        
        // Admin login
        function attemptAdminLogin() {
            const enteredPassword = adminPassword.value;
            if (checkAdminPassword(enteredPassword)) {
                isAdminAuthenticated = true;
                localStorage.setItem('changeDetectionAdminMode', 'true');
                toggleControlOptions(true);
                loginError.style.display = 'none';
                log('Admin login successful');
            } else {
                loginError.style.display = 'block';
                log('Admin login failed - incorrect password');
            }
        }
        
        // Toggle between login and control options
        function toggleControlOptions(showOptions) {
            loginSection.style.display = showOptions ? 'none' : 'block';
            controlOptions.style.display = showOptions ? 'block' : 'none';
            
            // Clear password field
            adminPassword.value = '';
        }
        
        // Update visibility of admin UI elements
        function updateAdminUI() {
            // Update skip buttons
            const skipButtons = document.querySelectorAll('.skipButton');
            skipButtons.forEach(button => {
                button.style.display = isAdminModeActive ? 'block' : 'none';
            });
            
            // Update bypass button
            bypassIdCheckButton.style.display = isAdminModeActive ? 'block' : 'none';
            
            // Update debug info display
            debugInfo.style.display = isAdminModeActive ? 'block' : 'none';
			
			// Update timer visibility based on admin mode
            timerDisplay.style.display = isAdminModeActive ? 'block' : 'none';
        }
        
		function cleanupTimers() {
			// Clear the trial timeout
			if (state.trialTimeout) {
				clearTimeout(state.trialTimeout);
				state.trialTimeout = null;
			}
    
			// If there are any other interval timers running, they should be cleared here
			// Make sure the timeout message is hidden
			timeoutMessage.style.display = 'none';
    
			// Reset the timer display
			timerDisplay.textContent = langDict[currentLang].timerDisplay + "00:00";
			
			// Hide the timer display
			timerDisplay.style.display = 'none';
    
			log('All timers cleared');
		}
		
		function startResponseTimer() {
            state.trialStartTime = Date.now();
            updateTimerDisplay();
            
            // Set up interval to update the timer display (only visible in admin mode)
            const timerInterval = setInterval(() => {
                if (!state.isRunning) {
                    clearInterval(timerInterval);
                    return;
                }
                updateTimerDisplay();
            }, 100); // Update every 100ms
            
            // Set timeout for trial
            state.trialTimeout = setTimeout(() => {
                if (state.isRunning) {
                    handleTimeout();
                }
            }, config.responseTimeLimit);
        }
        
        // Function to update the timer display
        function updateTimerDisplay() {
            if (!state.isRunning || !isAdminModeActive) return;
            
            const elapsedTime = Date.now() - state.trialStartTime;
            const seconds = Math.floor(elapsedTime / 1000);
            const milliseconds = Math.floor((elapsedTime % 1000) / 10);
            
            timerDisplay.textContent = langDict[currentLang].timerDisplay + 
                seconds.toString().padStart(2, '0') + ":" + 
                milliseconds.toString().padStart(2, '0');
        }
        
        // Function to handle timeout
        function handleTimeout() {
            // Check if we're still running (might have responded just before timeout)
            if (!state.isRunning) return;
            
            // Show timeout message
            timeoutMessage.style.display = 'block';
            
            // Disable responses
            disableResponses();
            state.isRunning = false;
            
            // Record response time as the time limit
            state.responseTimes.push(config.responseTimeLimit / 1000); // Convert to seconds
            state.timeoutTrials.push(state.currentTrial);
            
            // Mark as incorrect (this affects accuracy calculation)
            // state.correctResponses remains unchanged
            
            // Update trial counter
            state.currentTrial++;
            
            log(`Trial ${state.currentTrial}: Timeout - no response within ${config.responseTimeLimit / 1000} seconds`);
            
            // Update results
            updateResults();
            
            // Hide the timeout message after a brief delay
            setTimeout(() => {
                timeoutMessage.style.display = 'none';
                
                // Check if experiment is complete
                if (state.currentTrial >= config.numTrials) {
                    experimentComplete();
                } else {
                    // Start next trial
                    setTimeout(startTrial, 1000);
                }
            }, 1500); // Show message for 1.5 seconds
        }
		
        // Toggle debug logs
        function toggleLogs() {
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }
        
        // Confirmation dialog functions
        function showConfirmation(title, message, confirmCallback) {
            confirmationTitle.textContent = title;
            confirmationMessage.textContent = message;
            confirmationModal.style.display = 'block';
            
            // Remove previous event listener and add new one
            if (confirmYesButton.lastCallback) {
                confirmYesButton.removeEventListener('click', confirmYesButton.lastCallback);
            }
            
            confirmYesButton.lastCallback = function() {
                confirmCallback();
                closeConfirmation();
            };
            
            confirmYesButton.addEventListener('click', confirmYesButton.lastCallback);
        }
        
        function closeConfirmation() {
            confirmationModal.style.display = 'none';
        }
        
        // Clear Google Sheet
        function clearGoogleSheet() {
            log('Attempting to clear Google Sheet...');
            
            // Show loading indicator
            savingMessage.style.display = 'block';
            savingMessage.innerHTML = `<h2>${langDict[currentLang].savingText}</h2>`;
            
            // Send request to Google Script to clear the sheet
            fetch(GOOGLE_SCRIPT_URL + '?action=clearSheet', {
                method: 'GET',
                mode: 'no-cors'
            })
            .then(() => {
                log('Google Sheet cleared successfully');
                savingMessage.style.display = 'none';
                alert(currentLang === 'en' ? langDict[currentLang].sheetCleared : langDict[currentLang].sheetCleared);
            })
            .catch(error => {
                log('Error clearing Google Sheet: ' + error.toString());
                savingMessage.style.display = 'none';
                alert(currentLang === 'en' ? 'Error clearing Google Sheet: ' + error.toString() : 
                      'שגיאה בניקוי גיליון Google: ' + error.toString());
            });
        }
        
        // Clear local storage of participant and device IDs
        function clearLocalStorage() {
            localStorage.removeItem('changeDetectionParticipants');
            localStorage.removeItem('changeDetectionDevices');
            localStorage.removeItem('changeDetectionParticipantDeviceMap');
            
            log('Local storage cleared - removed all participant and device IDs');
            alert(currentLang === 'en' ? langDict[currentLang].localStorageCleared : langDict[currentLang].localStorageCleared);
        }
        
        // Test connection to Google Sheets
        function testConnection() {
            log('Testing connection to Google Sheets...');
            
            // Hide form until we confirm connection
            participantIdForm.style.display = 'none';
            connectionErrorMessage.style.display = 'none';
            
            // Show some indication that we're testing
            savingMessage.style.display = 'block';
            savingMessage.innerHTML = `<h2>${langDict[currentLang].savingText}</h2>`;
            
            // Try to ping Google Script URL
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'HEAD',
                mode: 'no-cors',
                cache: 'no-cache'
            })
            .then(() => {
                // Connection successful
                log('Connection to Google successful');
                isInternetConnected = true;
                savingMessage.style.display = 'none';
                participantIdForm.style.display = 'block';
                connectionErrorMessage.style.display = 'none';
            })
            .catch(error => {
                // Connection failed
                log('Connection to Google failed: ' + error);
                isInternetConnected = false;
                savingMessage.style.display = 'none';
                participantIdForm.style.display = 'none';
                connectionErrorMessage.style.display = 'block';
                // Show debug info in case it helps troubleshoot
                debugInfo.style.display = 'block';
            });
        }
        
        // Generate or retrieve a device ID
        function getDeviceId() {
            let storedDeviceId = localStorage.getItem('changeDetectionDeviceId');
            
            if (!storedDeviceId) {
                // Generate a new device ID using various available device info
                let newId = '';
                
                // Use available browser info to create a somewhat unique ID
                newId += navigator.userAgent || '';
                newId += screen.width || '';
                newId += screen.height || '';
                newId += navigator.language || '';
                newId += new Date().getTimezoneOffset() || '';
                
                // Hash the collected info
                storedDeviceId = hashString(newId);
                
                // Store it for future use
                localStorage.setItem('changeDetectionDeviceId', storedDeviceId);
                console.log('Generated new device ID: ' + storedDeviceId);
            } else {
                console.log('Retrieved existing device ID: ' + storedDeviceId);
            }
            
            return storedDeviceId;
        }
        
        // Generate a unique 8-character completion code
        function generateCompletionCode() {
            // Create a code based on participant ID, device ID, timestamp, and a random component
            // but ensure it's always exactly 8 characters
            
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed similar looking characters
            let code = '';
            
            // Add 4 characters derived from participant ID + device ID (deterministic part)
            const combinedId = participantId + deviceId;
            const hash = hashString(combinedId);
            for (let i = 0; i < 4; i++) {
                const index = Math.abs(parseInt(hash.charAt(i), 16)) % characters.length;
                code += characters.charAt(index);
            }
            
            // Add 4 random characters (to ensure uniqueness)
            for (let i = 0; i < 4; i++) {
                const randomIndex = Math.floor(Math.random() * characters.length);
                code += characters.charAt(randomIndex);
            }
            
            log('Generated completion code: ' + code);
            return code;
        }
        
        // Simple hash function for strings
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString(16); // Convert to hex
        }
        
        // Check admin password
        function checkAdminPassword(inputPassword) {
            return inputPassword === ADMIN_PASSWORD;
        }
        
        // Check if this device or participant ID has already completed the study
        function checkPreviousParticipation(participantId) {
            // Get the lists of previous participants and devices
            const previousParticipantIds = JSON.parse(localStorage.getItem('changeDetectionParticipants') || '[]');
            const previousDeviceIds = JSON.parse(localStorage.getItem('changeDetectionDevices') || '[]');
            
            // Mapping of participant IDs to device IDs (to detect same ID on different device)
            const participantToDeviceMap = JSON.parse(localStorage.getItem('changeDetectionParticipantDeviceMap') || '{}');
            
            // Check if this participant ID has already been used
            const participantExists = previousParticipantIds.includes(participantId);
            
            // Check if this device ID has already been used
            const deviceExists = previousDeviceIds.includes(deviceId);
            
            // Check if the participant ID has been used but on a different device
            const previousDeviceId = participantToDeviceMap[participantId];
            const sameIdDifferentDevice = previousDeviceId && previousDeviceId !== deviceId;
            
            // Log the check results
            console.log(`Checking previous participation - Participant: ${participantExists ? 'EXISTS' : 'new'}, Device: ${deviceExists ? 'EXISTS' : 'new'}, Same ID different device: ${sameIdDifferentDevice ? 'YES' : 'no'}`);
            
            // Store the check result
            state.sameIdDifferentDevice = sameIdDifferentDevice;
            
            // Return true if either the participant or device has already participated
            return participantExists || deviceExists;
        }
        
        // Record this participation to prevent duplicates
        function recordParticipation(participantId) {
            // Get the current lists
            const previousParticipantIds = JSON.parse(localStorage.getItem('changeDetectionParticipants') || '[]');
            const previousDeviceIds = JSON.parse(localStorage.getItem('changeDetectionDevices') || '[]');
            const participantToDeviceMap = JSON.parse(localStorage.getItem('changeDetectionParticipantDeviceMap') || '{}');
            
            // Add the current participant and device
            if (!previousParticipantIds.includes(participantId)) {
                previousParticipantIds.push(participantId);
                localStorage.setItem('changeDetectionParticipants', JSON.stringify(previousParticipantIds));
            }
            
            if (!previousDeviceIds.includes(deviceId)) {
                previousDeviceIds.push(deviceId);
                localStorage.setItem('changeDetectionDevices', JSON.stringify(previousDeviceIds));
            }
            
            // Map this participant ID to this device ID
            participantToDeviceMap[participantId] = deviceId;
            localStorage.setItem('changeDetectionParticipantDeviceMap', JSON.stringify(participantToDeviceMap));
            
            console.log('Recorded participation for participant ID: ' + participantId + ' and device ID: ' + deviceId);
        }
        
        // Debug logging function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);
            
            // Also log to debug div
            const logLine = document.createElement('div');
            logLine.textContent = logEntry;
            debugInfo.appendChild(logLine);
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            // Generate or retrieve the device ID
            deviceId = getDeviceId();
            log('Device ID: ' + deviceId);
            
            // Check if mobile and adjust interface
            log(`Device type: ${isMobile ? 'Mobile' : 'Desktop'}`);
            
            // Check if we have local storage available
            if (typeof(Storage) !== "undefined") {
                log('Local storage is available for tracking participation');
            } else {
                log('WARNING: Local storage is not available. Participation tracking disabled.');
            }
            
            // Set initial language
            updateLanguage();
            
            // Initialize admin controls
            initAdminControls();
            
            // Test internet connection to Google Sheets
            testConnection();
        });
        
        // Retry connection button event listener
        retryConnectionButton.addEventListener('click', function() {
            testConnection();
        });

        // Start the experiment after entering participant ID
        startExperimentButton.addEventListener('click', function() {
            // Clear any previous error messages
            previousParticipationWarning.style.display = 'none';
            sameIdDifferentDeviceWarning.style.display = 'none';
            invalidIdLengthWarning.style.display = 'none';
            
            // Get and validate the ID
            const idValue = participantIdInput.value.trim();
            
            if (idValue === '') {
                alert(currentLang === "en" ? 'Please enter a Participant ID' : 'אנא הזן/י מזהה משתתף');
                return;
            }
            
            // Check the length of the ID (must be exactly 9 characters)
            if (idValue.length !== 9) {
                log('Invalid Participant ID length: ' + idValue.length + ' characters (must be exactly 9)');
                participantIdForm.style.display = 'block';
                invalidIdLengthWarning.style.display = 'block';
                
                // Show bypass button if admin mode is active
                if (isAdminModeActive) {
                    bypassIdCheckButton.style.display = 'block';
                }
                return;
            }
            
            participantId = idValue;
            
            // If admin mode is active, bypass the previous participation check
            if (isAdminModeActive) {
                log('Admin mode active: Bypassing previous participation check');
                startInstructionSequence();
                return;
            }
            
            // Check for previous participation
            if (checkPreviousParticipation(participantId)) {
                // Check if it's a case of same ID used on different device
                if (state.sameIdDifferentDevice) {
                    // Show specific warning for same ID on different device
                    participantIdForm.style.display = 'none';
                    sameIdDifferentDeviceWarning.style.display = 'block';
                    log('Same ID on different device detected. Showing specific warning.');
                    
                    // Show bypass button if admin mode is active
                    if (isAdminModeActive) {
                        bypassIdCheckButton.style.display = 'block';
                    }
                } else {
                    // Regular previous participation warning
                    participantIdForm.style.display = 'none';
                    previousParticipationWarning.style.display = 'block';
                    log('Previous participation detected. Showing warning.');
                    
                    // Show bypass button if admin mode is active
                    if (isAdminModeActive) {
                        bypassIdCheckButton.style.display = 'block';
                    }
                }
            } else {
                startInstructionSequence();
            }
        });
        
        // Function to start the instruction sequence
        function startInstructionSequence() {
            // Hide the participant ID form
            participantIdForm.style.display = 'none';
            
            // Show the instructions page
            instructionsPage.style.display = 'block';
            
            // Start the 5-second timer for the instructions page
            let timeLeft = 5;
            const instructionsInterval = setInterval(function() {
                timeLeft--;
                instructionsTimer.textContent = langDict[currentLang].instructionsTimerRemaining.replace('{0}', timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(instructionsInterval);
                    instructionsTimer.textContent = langDict[currentLang].instructionsTimer;
                    instructionsUnderstoodButton.disabled = false;
                    instructionsUnderstoodButton.textContent = langDict[currentLang].instructionsUnderstoodButton;
                }
            }, 1000);
            
            log('Showing instruction sequence - page 1');
        }
        
        // Event listener for the "I understand" button
        instructionsUnderstoodButton.addEventListener('click', function() {
            // Hide instructions page
            instructionsPage.style.display = 'none';
            
            // Show no-change training page
            noChangeTrainingPage.style.display = 'block';
            
            log('Moving to no-change training page');
        });
        
        // Run no-change training trial
        function runNoChangeTraining() {
            // Disable start button
            startNoChangeTraining.disabled = true;
            
            // Clear any previous feedback
            noChangeFeedback.style.display = 'none';
            
            // Create stimulus positions for training
            const trainingPositions = [];
            for (let i = 0; i < config.numStimuli; i++) {
                const x = Math.random() * config.maxPos * (noChangeTrainingArea.offsetWidth - config.stimulusSize);
                const y = Math.random() * config.maxPos * (noChangeTrainingArea.offsetHeight - config.stimulusSize);
                trainingPositions.push({ x, y });
            }
            
            // Create random color indices for training
            const trainingColorIndices = [];
            const shuffledIndices = [...Array(stimuliColors.length).keys()];
            // Shuffle the indices
            for (let i = shuffledIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledIndices[i], shuffledIndices[j]] = [shuffledIndices[j], shuffledIndices[i]];
            }
            
            // Assign unique colors
            for (let i = 0; i < config.numStimuli; i++) {
                trainingColorIndices.push(shuffledIndices[i % shuffledIndices.length]);
            }
            
            // Display stimuli in training area
            clearTrainingArea(noChangeTrainingArea);
            displayStimuliInTrainingArea(trainingPositions, noChangeTrainingArea, trainingColorIndices);
            
            log('No-change training: displaying initial stimuli');
            
            // After study time, show blank screen
            setTimeout(() => {
                clearTrainingArea(noChangeTrainingArea);
                
                // After blank time, show test stimuli (identical for no-change training)
                setTimeout(() => {
                    // Use the same positions (no change)
                    displayStimuliInTrainingArea(trainingPositions, noChangeTrainingArea, trainingColorIndices);
                    
                    // Enable response buttons
                    noChangeTrainingYes.disabled = false;
                    noChangeTrainingNo.disabled = false;
                    
                    log('No-change training: displaying test stimuli (no change)');
                }, config.blankTime);
            }, config.studyTime);
        }
        
        // Event listeners for no-change training
        startNoChangeTraining.addEventListener('click', runNoChangeTraining);
        
        noChangeTrainingYes.addEventListener('click', function() {
            // Disable response buttons
            noChangeTrainingYes.disabled = true;
            noChangeTrainingNo.disabled = true;
            
            // Show incorrect feedback
            noChangeFeedback.textContent = langDict[currentLang].noChangeFeedbackIncorrect;
            noChangeFeedback.style.color = 'red';
            noChangeFeedback.style.display = 'block';
            
            log('No-change training: incorrect response ("yes")');
            
            // Enable retry after 5 seconds
            setTimeout(function() {
                startNoChangeTraining.disabled = false;
                noChangeFeedback.textContent += " " + langDict[currentLang].noChangeFeedbackRetry;
            }, 5000);
        });
        
        noChangeTrainingNo.addEventListener('click', function() {
            // Disable response buttons
            noChangeTrainingYes.disabled = true;
            noChangeTrainingNo.disabled = true;
            
            // Show correct feedback
            noChangeFeedback.textContent = langDict[currentLang].noChangeFeedbackCorrect;
            noChangeFeedback.style.color = 'green';
            noChangeFeedback.style.display = 'block';
            
            log('No-change training: correct response ("no")');
            
            // Move to change training after 2 seconds
            setTimeout(function() {
                noChangeTrainingPage.style.display = 'none';
                changeTrainingPage.style.display = 'block';
            }, 2000);
        });
        
        // Run change training trial
        function runChangeTraining() {
            // Disable start button
            startChangeTraining.disabled = true;
            
            // Clear any previous feedback
            changeFeedback.style.display = 'none';
            
            // Create stimulus positions for training
            const initialPositions = [];
            for (let i = 0; i < config.numStimuli; i++) {
                const x = Math.random() * config.maxPos * (changeTrainingArea.offsetWidth - config.stimulusSize);
                const y = Math.random() * config.maxPos * (changeTrainingArea.offsetHeight - config.stimulusSize);
                initialPositions.push({ x, y });
            }
            
            // Create random color indices for training
            const trainingColorIndices = [];
            const shuffledIndices = [...Array(stimuliColors.length).keys()];
            // Shuffle the indices
            for (let i = shuffledIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledIndices[i], shuffledIndices[j]] = [shuffledIndices[j], shuffledIndices[i]];
            }
            
            // Assign unique colors
            for (let i = 0; i < config.numStimuli; i++) {
                trainingColorIndices.push(shuffledIndices[i % shuffledIndices.length]);
            }
            
            // Display stimuli in training area
            clearTrainingArea(changeTrainingArea);
            displayStimuliInTrainingArea(initialPositions, changeTrainingArea, trainingColorIndices);
            
            log('Change training: displaying initial stimuli');
            
            // After study time, show blank screen
            setTimeout(() => {
                clearTrainingArea(changeTrainingArea);
                
                // After blank time, show test stimuli with a change
                setTimeout(() => {
                    // Determine how many objects will move (between 1-3)
                    const numObjectsToMove = Math.floor(Math.random() * 
                        (config.maxObjectsToMove - config.minObjectsToMove + 1)) + config.minObjectsToMove;
                    
                    // Decide if we're swapping or moving randomly
                    const isSwapping = Math.random() < config.swapProbability;
                    
                    // Create changed positions
                    const changedPositions = [...initialPositions];
                    
                    if (isSwapping && numObjectsToMove === 2) {
                        // Swap positions of two random objects
                        const indices = getRandomIndices(config.numStimuli, 2);
                        const temp = { ...changedPositions[indices[0]] };
                        changedPositions[indices[0]] = { ...changedPositions[indices[1]] };
                        changedPositions[indices[1]] = temp;
                        
                        log(`Change training: Swapped positions of stimuli ${indices[0]} and ${indices[1]}`);
                    } else {
                        // Move random objects with distance constraints
                        const indices = getRandomIndices(config.numStimuli, numObjectsToMove);
                        indices.forEach(index => {
                            const oldPos = changedPositions[index];
                            
                            // Calculate new position with minimum and maximum distance constraints
                            let newPos;
                            let distance;
                            let attempts = 0;
                            
                            do {
                                // Generate a potential new position
                                const newX = Math.random() * config.maxPos * (changeTrainingArea.offsetWidth - config.stimulusSize);
                                const newY = Math.random() * config.maxPos * (changeTrainingArea.offsetHeight - config.stimulusSize);
                                newPos = { x: newX, y: newY };
                                
                                // Calculate distance from old position
                                distance = Math.sqrt(
                                    Math.pow(newPos.x - oldPos.x, 2) + 
                                    Math.pow(newPos.y - oldPos.y, 2)
                                );
                                
                                attempts++;
                                
                                // Break after too many attempts to avoid infinite loop
                                if (attempts > 100) break;
                            } while (
                                distance < config.minMoveDistance() || 
                                distance > config.maxMoveDistance()
                            );
                            
                            // Apply the new position
                            changedPositions[index] = newPos;
                        });
                        
                        log(`Change training: Changed positions of ${numObjectsToMove} stimuli: ${indices.join(', ')}`);
                    }
                    
                    // Display changed stimuli
                    displayStimuliInTrainingArea(changedPositions, changeTrainingArea, trainingColorIndices);
                    
                    // Enable response buttons
                    changeTrainingYes.disabled = false;
                    changeTrainingNo.disabled = false;
                }, config.blankTime);
            }, config.studyTime);
        }
        
        // Event listeners for change training
        startChangeTraining.addEventListener('click', runChangeTraining);
        
        // Replace the changeTrainingYes event listener with:
		changeTrainingYes.addEventListener('click', function() {
			changeTrainingYes.disabled = true;
			changeTrainingNo.disabled = true;
			
			changeFeedback.textContent = langDict[currentLang].changeFeedbackCorrect;
			changeFeedback.style.color = 'green';
			changeFeedback.style.display = 'block';
			
			log('Change training: correct response ("yes")');
			
			// Move to practice trials after 2 seconds
			setTimeout(function() {
				changeTrainingPage.style.display = 'none';
				practiceTrialsPage.style.display = 'block';
				initPracticeTrials();
			}, 2000);
		});
			
        changeTrainingNo.addEventListener('click', function() {
            // Disable response buttons
            changeTrainingYes.disabled = true;
            changeTrainingNo.disabled = true;
            
            // Show incorrect feedback
            changeFeedback.textContent = langDict[currentLang].changeFeedbackIncorrect;
            changeFeedback.style.color = 'red';
            changeFeedback.style.display = 'block';
            
            log('Change training: incorrect response ("no")');
            
            // Enable retry after 5 seconds
            setTimeout(function() {
                startChangeTraining.disabled = false;
                changeFeedback.textContent += " " + langDict[currentLang].changeFeedbackRetry;
            }, 5000);
        });
        
        // Helper functions for training trials
        function clearTrainingArea(area) {
            while (area.firstChild) {
                area.removeChild(area.firstChild);
            }
        }
        
        function displayStimuliInTrainingArea(positions, area, colorIndices) {
            positions.forEach((pos, index) => {
                const stimulus = document.createElement('div');
                stimulus.className = 'stimulus';
                stimulus.style.left = pos.x + 'px';
                stimulus.style.top = pos.y + 'px';
                stimulus.style.width = config.stimulusSize + 'px';
                stimulus.style.height = config.stimulusSize + 'px';
                
                // Use the provided color indices
                const colorIndex = colorIndices[index];
                stimulus.style.backgroundColor = stimuliColors[colorIndex];
                
                area.appendChild(stimulus);
            });
        }

		// Practice trials implementation
		function initPracticeTrials() {
			state.practiceTrials = [];
			state.currentPracticeTrial = 0;
			state.practiceCorrect = 0;
			state.practiceAttempt = 0;
			
			// Generate 3 practice trials (mix of change and no-change)
			for (let i = 0; i < 3; i++) {
				state.practiceTrials.push({
					hasChange: Math.random() < 0.5, // 50% chance of change
					positions: [],
					testPositions: [],
					colorIndices: []
				});
			}
			
			updatePracticeTrialNumber();
		}
		
		function runPracticeTrial() {
			if (state.currentPracticeTrial >= 3) {
				completePracticeTrials();
				return;
			}
			
			state.isPracticeRunning = true;
			startPracticeTrial.disabled = true;
			practiceFeedback.style.display = 'none';
			
			const trial = state.practiceTrials[state.currentPracticeTrial];
			
			// Generate random positions
			trial.positions = [];
			for (let i = 0; i < config.numStimuli; i++) {
				const x = Math.random() * config.maxPos * (practiceArea.offsetWidth - config.stimulusSize);
				const y = Math.random() * config.maxPos * (practiceArea.offsetHeight - config.stimulusSize);
				trial.positions.push({ x, y });
			}
			
			// Generate random colors
			trial.colorIndices = [];
			const shuffledIndices = [...Array(stimuliColors.length).keys()];
			for (let i = shuffledIndices.length - 1; i > 0; i--) {
				const j = Math.floor(Math.random() * (i + 1));
				[shuffledIndices[i], shuffledIndices[j]] = [shuffledIndices[j], shuffledIndices[i]];
			}
			for (let i = 0; i < config.numStimuli; i++) {
				trial.colorIndices.push(shuffledIndices[i % shuffledIndices.length]);
			}
			
			// Display initial stimuli
			clearPracticeArea(practiceArea);
			displayStimuliInPracticeArea(trial.positions, practiceArea, trial.colorIndices);
			
			log(`Practice trial ${state.currentPracticeTrial + 1}: ${trial.hasChange ? 'Change' : 'No change'}`);
			
			// After study time, blank screen
			setTimeout(() => {
				clearPracticeArea(practiceArea);
				
				// After blank time, show test stimuli
				setTimeout(() => {
					trial.testPositions = [...trial.positions];
					
					if (trial.hasChange) {
						// Apply changes (same logic as main experiment)
						const numObjectsToMove = Math.floor(Math.random() * 
							(config.maxObjectsToMove - config.minObjectsToMove + 1)) + config.minObjectsToMove;
						
						const isSwapping = Math.random() < config.swapProbability;
						
						if (isSwapping && numObjectsToMove === 2) {
							const indices = getRandomIndices(config.numStimuli, 2);
							const temp = { ...trial.testPositions[indices[0]] };
							trial.testPositions[indices[0]] = { ...trial.testPositions[indices[1]] };
							trial.testPositions[indices[1]] = temp;
						} else {
							const indices = getRandomIndices(config.numStimuli, numObjectsToMove);
							indices.forEach(index => {
								const oldPos = trial.testPositions[index];
								let newPos;
								let distance;
								let attempts = 0;
								
								do {
									const newX = Math.random() * config.maxPos * (practiceArea.offsetWidth - config.stimulusSize);
									const newY = Math.random() * config.maxPos * (practiceArea.offsetHeight - config.stimulusSize);
									newPos = { x: newX, y: newY };
									
									distance = Math.sqrt(
										Math.pow(newPos.x - oldPos.x, 2) + 
										Math.pow(newPos.y - oldPos.y, 2)
									);
									
									attempts++;
									if (attempts > 100) break;
								} while (
									distance < config.minMoveDistance() || 
									distance > config.maxMoveDistance()
								);
								
								trial.testPositions[index] = newPos;
							});
						}
					}
					
					// Display test stimuli
					displayStimuliInPracticeArea(trial.testPositions, practiceArea, trial.colorIndices);
					
					// Enable responses and start timer
					practiceYes.disabled = false;
					practiceNo.disabled = false;
					startResponseTimer(); // Use the existing timer function
					
				}, config.blankTime);
			}, config.studyTime);
		}
		
		function processPracticeResponse(response) {
			if (!state.isPracticeRunning) return;
			
			// Clear the timeout
			clearTimeout(state.trialTimeout);
			cleanupTimers();
			
			practiceYes.disabled = true;
			practiceNo.disabled = true;
			state.isPracticeRunning = false;
			
			const trial = state.practiceTrials[state.currentPracticeTrial];
			const isCorrect = (response === 'yes' && trial.hasChange) || 
							(response === 'no' && !trial.hasChange);
			
			if (isCorrect) {
				state.practiceCorrect++;
				practiceFeedback.textContent = langDict[currentLang].practiceFeedbackCorrect;
				practiceFeedback.style.color = 'green';
				practiceFeedback.style.display = 'block';
				
				state.currentPracticeTrial++;
				
				if (state.currentPracticeTrial < 3) {
					updatePracticeTrialNumber();
					setTimeout(() => {
						practiceFeedback.style.display = 'none';
						startPracticeTrial.disabled = false;
					}, 1500);
				} else {
					// All trials completed
					setTimeout(completePracticeTrials, 1500);
				}
			} else {
				practiceFeedback.textContent = langDict[currentLang].practiceFeedbackIncorrect;
				practiceFeedback.style.color = 'red';
				practiceFeedback.style.display = 'block';
				
				// After 5 seconds, restart all practice trials
				setTimeout(retryAllPracticeTrials, 5000);
			}
			
			log(`Practice trial ${state.currentPracticeTrial + 1}: User responded "${response}", ${isCorrect ? 'correct' : 'incorrect'}`);
		}
		
		function handlePracticeTimeout() {
			if (!state.isPracticeRunning) return;
			
			// Show timeout message
			timeoutMessage.style.display = 'block';
			
			// Process as incorrect
			practiceYes.disabled = true;
			practiceNo.disabled = true;
			state.isPracticeRunning = false;
			
			log(`Practice trial ${state.currentPracticeTrial + 1}: Timeout`);
			
			setTimeout(() => {
				timeoutMessage.style.display = 'none';
				practiceFeedback.textContent = langDict[currentLang].practiceFeedbackIncorrect;
				practiceFeedback.style.color = 'red';
				practiceFeedback.style.display = 'block';
				
				setTimeout(retryAllPracticeTrials, 5000);
			}, 1500);
		}
		
		function retryAllPracticeTrials() {
			practiceFeedback.textContent = langDict[currentLang].practiceFeedbackRetry;
			practiceFeedback.style.color = 'red';
			
			setTimeout(() => {
				// Reset practice trials
				state.currentPracticeTrial = 0;
				state.practiceCorrect = 0;
				state.practiceAttempt++;
				
				// Generate new practice trials
				initPracticeTrials();
				
				practiceFeedback.style.display = 'none';
				startPracticeTrial.disabled = false;
			}, 5000);
		}
		
		function completePracticeTrials() {
			practiceFeedback.textContent = langDict[currentLang].practiceFeedbackComplete;
			practiceFeedback.style.color = 'green';
			
			setTimeout(() => {
				practiceTrialsPage.style.display = 'none';
				experimentArea.style.display = 'block';
				initExperiment();
			}, 3000);
		}
		
		function updatePracticeTrialNumber() {
			practiceTrialNumber.textContent = langDict[currentLang].practiceTrialNumber.replace('{0}', state.currentPracticeTrial + 1);
		}
		
		// Helper functions for practice trials
		function clearPracticeArea(area) {
    		while (area.firstChild) {
        		area.removeChild(area.firstChild);
    		}
		}
		
		function displayStimuliInPracticeArea(positions, area, colorIndices) {
    		positions.forEach((pos, index) => {
        		const stimulus = document.createElement('div');
        		stimulus.className = 'stimulus';
        		stimulus.style.left = pos.x + 'px';
        		stimulus.style.top = pos.y + 'px';
        		stimulus.style.width = config.stimulusSize + 'px';
        		stimulus.style.height = config.stimulusSize + 'px';
        		stimulus.style.backgroundColor = stimuliColors[colorIndices[index]];
        		area.appendChild(stimulus);
    		});
		}
		
		// Update the handleTimeout function to handle practice trials
		// Replace the existing handleTimeout function with:
		function handleTimeout() {
			if (!state.isRunning && !state.isPracticeRunning) return;
			
			if (state.isPracticeRunning) {
				handlePracticeTimeout();
				return;
			}
			
			// Original timeout handling for main experiment
			timeoutMessage.style.display = 'block';
			disableResponses();
			state.isRunning = false;
			
			state.responseTimes.push(config.responseTimeLimit / 1000);
			state.timeoutTrials.push(state.currentTrial);
			state.currentTrial++;
			
			log(`Trial ${state.currentTrial}: Timeout - no response within ${config.responseTimeLimit / 1000} seconds`);
			
			updateResults();
			
			setTimeout(() => {
				timeoutMessage.style.display = 'none';
				
				if (state.currentTrial >= config.numTrials) {
					experimentComplete();
				} else {
					setTimeout(startTrial, 1000);
				}
			}, 1500);
		}
		
		// Initialize the experiment
		function initExperiment() {
			state.currentTrial = 0;
            state.correctResponses = 0;
            state.dataSaved = false;
            
            // Make sure the results div is available for updating
            if (!document.getElementById('trialsCompleted') || 
                !document.getElementById('correctResponses') || 
                !document.getElementById('accuracy')) {
                log('Warning: Results elements not found. Creating them to avoid errors.');
                
                // If we can't find the elements, make sure they exist
                if (!document.getElementById('results')) {
                    const resultsContainer = document.createElement('div');
                    resultsContainer.id = 'results';
                    resultsContainer.style.display = 'none';
                    document.body.appendChild(resultsContainer);
                }
                
                const resultsDiv = document.getElementById('results');
                
                if (!document.getElementById('trialsCompleted')) {
                    const p = document.createElement('p');
                    p.id = 'trialsCompletedLabel';
                    p.innerHTML = `${langDict[currentLang].trialsCompletedLabel} <span id="trialsCompleted">0</span>`;
                    resultsDiv.appendChild(p);
                }
                
                if (!document.getElementById('correctResponses')) {
                    const p = document.createElement('p');
                    p.id = 'correctResponsesLabel';
                    p.innerHTML = `${langDict[currentLang].correctResponsesLabel} <span id="correctResponses">0</span>`;
                    resultsDiv.appendChild(p);
                }
                
                if (!document.getElementById('accuracy')) {
                    const p = document.createElement('p');
                    p.id = 'accuracyLabel';
                    p.innerHTML = `${langDict[currentLang].accuracyLabel} <span id="accuracy">0</span>%`;
                    resultsDiv.appendChild(p);
                }
            }
            
            updateResults();
            startButton.disabled = false;
            startButton.style.display = 'block'; // Ensure start button is visible when initializing
            responseYes.disabled = true;
            responseNo.disabled = true;
            
            // Hide results and thank you message
            resultsDiv.style.display = 'none';
            thankYouMessage.style.display = 'none';
            savingMessage.style.display = 'none';
            showResultsButton.style.display = 'none';
            showLogButton.style.display = 'none';
            openSpreadsheetButton.style.display = 'none';
            retryButton.style.display = 'none';
            
            // Show controls and instructions
            instructionsDiv.style.display = 'block';
            controlsDiv.style.display = 'block';
            stimuliArea.style.display = 'block';
            
            // Hide debug info initially if not in admin mode
            if (!isAdminModeActive) {
                debugInfo.style.display = 'none';
            }
            debugInfo.innerHTML = '';
            log('Experiment initialized');
        }

        // Start a trial
        function startTrial() {
            state.isRunning = true;
            clearStimuliArea();
            
			// Hide the Control Panel button during trials
			controlPanelButton.style.display = "none";
			
            // Hide the start button during the experiment
            startButton.style.display = 'none';
            
            log(`Starting trial ${state.currentTrial + 1} of ${config.numTrials}`);
            
            // Generate stimuli positions
            state.stimuliPositions = [];
            for (let i = 0; i < config.numStimuli; i++) {
                const x = Math.random() * config.maxPos * (stimuliArea.offsetWidth - config.stimulusSize);
                const y = Math.random() * config.maxPos * (stimuliArea.offsetHeight - config.stimulusSize);
                state.stimuliPositions.push({ x, y });
            }
            
            // Randomize colors for this trial
            randomizeColors();
            
            // Display stimuli
            displayStimuli(state.stimuliPositions);
            
            // After study time, show blank screen
            setTimeout(() => {
                clearStimuliArea();
                
                // After blank time, show test stimuli
                setTimeout(() => {
                    // Determine if there's a change
                    state.hasChange = Math.random() < config.changeProb;
                    
                    let testPositions = [...state.stimuliPositions];
                    if (state.hasChange) {
                        // Determine how many objects will move (between 1-3)
                        const numObjectsToMove = Math.floor(Math.random() * 
                            (config.maxObjectsToMove - config.minObjectsToMove + 1)) + config.minObjectsToMove;
                        
                        // Decide if we're swapping or moving randomly
                        const isSwapping = Math.random() < config.swapProbability;
                        
                        if (isSwapping && numObjectsToMove === 2) {
                            // Swap positions of two random objects
                            const indices = getRandomIndices(config.numStimuli, 2);
                            const temp = { ...testPositions[indices[0]] };
                            testPositions[indices[0]] = { ...testPositions[indices[1]] };
                            testPositions[indices[1]] = temp;
                            
                            log(`Trial ${state.currentTrial + 1}: Swapped positions of stimuli ${indices[0]} and ${indices[1]}`);
                        } else {
                            // Move random objects with distance constraints
                            const indices = getRandomIndices(config.numStimuli, numObjectsToMove);
                            indices.forEach(index => {
                                const oldPos = testPositions[index];
                                
                                // Calculate new position with minimum and maximum distance constraints
                                let newPos;
                                let distance;
                                let attempts = 0;
                                
                                do {
                                    // Generate a potential new position
                                    const newX = Math.random() * config.maxPos * (stimuliArea.offsetWidth - config.stimulusSize);
                                    const newY = Math.random() * config.maxPos * (stimuliArea.offsetHeight - config.stimulusSize);
                                    newPos = { x: newX, y: newY };
                                    
                                    // Calculate distance from old position
                                    distance = Math.sqrt(
                                        Math.pow(newPos.x - oldPos.x, 2) + 
                                        Math.pow(newPos.y - oldPos.y, 2)
                                    );
                                    
                                    attempts++;
                                    
                                    // Break after too many attempts to avoid infinite loop
                                    if (attempts > 100) break;
                                } while (
                                    distance < config.minMoveDistance() || 
                                    distance > config.maxMoveDistance()
                                );
                                
                                // Apply the new position
                                testPositions[index] = newPos;
                            });
                            
                            log(`Trial ${state.currentTrial + 1}: Changed positions of ${numObjectsToMove} stimuli: ${indices.join(', ')}`);
                        }
                    } else {
                        log(`Trial ${state.currentTrial + 1}: No change`);
                    }
                    
                    displayStimuli(testPositions);
                    enableResponses();
                    
                    // Start the response timer after displaying stimuli
                    startResponseTimer();
                    
                }, config.blankTime);
            }, config.studyTime);
        }

        // Display stimuli based on positions
        function displayStimuli(positions) {
            clearStimuliArea();
            positions.forEach((pos, index) => {
                const stimulus = document.createElement('div');
                stimulus.className = 'stimulus';
                stimulus.style.left = pos.x + 'px';
                stimulus.style.top = pos.y + 'px';
                stimulus.style.width = config.stimulusSize + 'px';
                stimulus.style.height = config.stimulusSize + 'px';
                
                // Apply the color for this stimulus (now randomized for each trial)
                const colorIndex = state.stimuliColorIndices[index];
                stimulus.style.backgroundColor = stimuliColors[colorIndex];
                
                stimuliArea.appendChild(stimulus);
            });
        }

        // Clear the stimuli area
        function clearStimuliArea() {
            while (stimuliArea.firstChild) {
                stimuliArea.removeChild(stimuliArea.firstChild);
            }
        }

        // Enable response buttons
        function enableResponses() {
            responseYes.disabled = false;
            responseNo.disabled = false;
        }

        // Disable response buttons
        function disableResponses() {
            responseYes.disabled = true;
            responseNo.disabled = true;
        }

        // Process response
        function processResponse(response) {
            if (!state.isRunning) return;
            
            // Clear the timeout
            clearTimeout(state.trialTimeout);
            
            disableResponses();
            state.isRunning = false;
            
            // Calculate and record response time
            const responseTime = (Date.now() - state.trialStartTime) / 1000; // Convert to seconds
            state.responseTimes.push(responseTime);
            
            // Check if response was correct
            const isCorrect = (response === 'yes' && state.hasChange) || 
                             (response === 'no' && !state.hasChange);
            
            log(`Trial ${state.currentTrial + 1}: User responded "${response}" in ${responseTime.toFixed(2)} seconds, which is ${isCorrect ? 'correct' : 'incorrect'}`);
            
            if (isCorrect) {
                state.correctResponses++;
            }
            
            // Update trial counter
            state.currentTrial++;
            
            try {
                // Update results display (but it's hidden during experiment)
                updateResults();
                
                // Check if experiment is complete
                if (state.currentTrial >= config.numTrials) {
                    experimentComplete();
                } else {
                    // Start next trial after a short delay
                    setTimeout(startTrial, 1000);
                }
            } catch (error) {
                log('Error in processResponse: ' + error.message);
                console.error('Error in processResponse:', error);
                
                // Continue with next trial even if there was an error
                if (state.currentTrial >= config.numTrials) {
                    experimentComplete();
                } else {
                    setTimeout(startTrial, 1000);
                }
            }
        }

        // Handle experiment completion
        function experimentComplete() {
			log(`Experiment complete. Score: ${state.correctResponses}/${state.currentTrial}`);
    
			// Clean up timers first to prevent any timeouts from triggering
			cleanupTimers();
    
			// Hide experiment elements
			experimentArea.style.display = 'none';
    
			// Make sure to show start button again in case user retries
			startButton.style.display = 'block';
			
			// Show Control Panel button again, but only if language is English
			controlPanelButton.style.display = currentLang === "he" ? "none" : "block";
    
			// Show saving message
			savingMessage.style.display = 'block';
    
			// Automatically save results
			saveResultsToSheet();
		}

        // Show thank you screen after saving
        function showThankYouScreen() {
			// Hide saving message
			savingMessage.style.display = 'none';
    
			// Display the completion code
			if(completionCodeElement) {
				completionCodeElement.textContent = completionCode;
			}
    
			// Show thank you message with completion code
			thankYouMessage.style.display = 'block';
    
			// REMOVED: Don't show the redundant buttons anymore, even in admin mode
			// if (isAdminModeActive) {
			//     resultsDiv.style.display = 'block';
			//     showResultsButton.style.display = 'block';
			//     showLogButton.style.display = 'block';
			//     openSpreadsheetButton.style.display = 'block';
			// }
			
			// Instead, just show results div if in admin mode (but not the buttons)
			// REMOVED: Don't show the results div or any admin buttons
			// if (isAdminModeActive) {
			//     resultsDiv.style.display = 'block';
			// }
    
			log('Showing thank you message with completion code: ' + completionCode);
		}

        // Update results display
        function updateResults() {
            // Add null checks to prevent errors
            const trialsCompletedElement = document.getElementById('trialsCompleted');
            const correctResponsesElement = document.getElementById('correctResponses');
            const accuracyElement = document.getElementById('accuracy');
            
            // Log for debugging
            console.log("Updating results. Trial:", state.currentTrial, "Correct:", state.correctResponses);
            
            // Only update if elements exist
            if (trialsCompletedElement) {
                trialsCompletedElement.textContent = state.currentTrial;
            }
            
            if (correctResponsesElement) {
                correctResponsesElement.textContent = state.correctResponses;
            }
            
            if (accuracyElement && state.currentTrial > 0) {
                const accuracy = (state.correctResponses / state.currentTrial * 100).toFixed(1);
                accuracyElement.textContent = accuracy;
            } else if (accuracyElement) {
                accuracyElement.textContent = '0';
            }
        }

        // Save results to Google Sheets with improved error handling
        function saveResultsToSheet() {
            if (state.dataSaved) {
                log('Data already saved, skipping save operation');
                showThankYouScreen();
                return;
            }
            
            log('Preparing to save data to Google Sheets');
            
            const accuracy = state.currentTrial > 0 
                ? (state.correctResponses / state.currentTrial * 100).toFixed(1) 
                : 0;
            
            // Generate the completion code
            completionCode = generateCompletionCode();
            
            // Format response times as a comma-separated string
            const responseTimesStr = state.responseTimes.map(time => time.toFixed(2)).join(',');
            
            // Create a status array for each trial (correct, incorrect, timeout)
            const trialStatuses = [];
            for (let i = 0; i < state.currentTrial; i++) {
                if (state.timeoutTrials.includes(i)) {
                    trialStatuses.push('timeout');
                } else {
                    // For non-timeout trials, check if the trial is in the first 'correctResponses' trials
                    // This is a simplification and assumes correctResponses are consecutive from the beginning
                    // If you want to track individual trial correctness, you'd need to store that info as trials progress
                    const isCorrect = i < state.correctResponses;
                    trialStatuses.push(isCorrect ? 'correct' : 'incorrect');
                }
            }
            const trialStatusesStr = trialStatuses.join(',');
                
            const data = {
                participantId: participantId,
                deviceId: deviceId,
                isMobile: isMobile,
                trialsCompleted: state.currentTrial,
                correctResponses: state.correctResponses,
                accuracy: accuracy,
                completionCode: completionCode,
                language: currentLang,
                adminMode: isAdminModeActive,
                responseTimes: responseTimesStr,
                trialStatuses: trialStatusesStr
            };
            
            log('Sending data: ' + JSON.stringify(data));
            saveStatus.textContent = langDict[currentLang].savingText;
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                log('Response received from Google Script');
                state.dataSaved = true;
                saveStatus.textContent = currentLang === "en" ? 'Results saved successfully!' : 'התוצאות נשמרו בהצלחה!';
                
                // Record this participation unless we're in admin mode
                if (!isAdminModeActive) {
                    recordParticipation(participantId);
                }
                
                // Show thank you screen
                showThankYouScreen();
            })
            .catch(error => {
                log('Error saving data: ' + error.message);
                saveStatus.textContent = currentLang === "en" ? 'Error saving data: ' + error.message : 'שגיאה בשמירת נתונים: ' + error.message;
                
                // Show retry button
                retryButton.style.display = 'block';
                
                // Still show thank you screen, but with error message
                showThankYouScreen();
            });
        }

        // Add event listener for the copy to clipboard button
        copyCodeButton.addEventListener('click', function() {
            // Create a temporary textarea element to copy from
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = completionCode;
            document.body.appendChild(tempTextArea);
            
            // Select the text
            tempTextArea.select();
            tempTextArea.setSelectionRange(0, 99999); // For mobile devices
            
            // Copy the text to clipboard
            document.execCommand('copy');
            
            // Remove the temporary element
            document.body.removeChild(tempTextArea);
            
            // Show feedback
            const originalText = copyCodeButton.textContent;
            copyCodeButton.textContent = langDict[currentLang].copyCodeButtonCopied;
            setTimeout(() => {
                copyCodeButton.textContent = originalText;
            }, 2000);
            
            log('Completion code copied to clipboard: ' + completionCode);
        });

        // Start experiment button
        startButton.addEventListener('click', function() {
            startButton.disabled = true;
            startTrial();
        });

        // Response buttons
        responseYes.addEventListener('click', function() {
            processResponse('yes');
        });

        responseNo.addEventListener('click', function() {
            processResponse('no');
        });

        // Admin result buttons
        showResultsButton.addEventListener('click', function() {
            resultsDiv.style.display = resultsDiv.style.display === 'none' ? 'block' : 'none';
        });
        
        showLogButton.addEventListener('click', function() {
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            showLogButton.textContent = debugInfo.style.display === 'none' ? 
                langDict[currentLang].showLogButton : langDict[currentLang].hideLogButton;
        });
        
        openSpreadsheetButton.addEventListener('click', function() {
            window.open(SPREADSHEET_URL, '_blank');
        });
        
        retryButton.addEventListener('click', saveResultsToSheet);

		
		skipPracticeTrialsButton.addEventListener('click', function() {
			log('Admin: Skipped practice trials');
			practiceTrialsPage.style.display = 'none';
			experimentArea.style.display = 'block';
			initExperiment();
		});
        
		// Practice trials event listeners
		startPracticeTrial.addEventListener('click', runPracticeTrial);
		
		practiceYes.addEventListener('click', function() {
			processPracticeResponse('yes');
		});
		
		practiceNo.addEventListener('click', function() {
			processPracticeResponse('no');
		});
		
        // Keyboard shortcuts
		document.addEventListener('keydown', function(event) {
			// Check if we're in different phases of the experiment
    
			// During main experiment
			if (!responseYes.disabled) {
				if (event.key === 'k' || event.key === 'K' || event.key === 'ל') {
					processResponse('yes');
				} else if (event.key === 'd' || event.key === 'D' || event.key === 'ג') {
					processResponse('no');
				}
			}
    
			// During no-change training
			if (!noChangeTrainingYes.disabled) {
				if (event.key === 'k' || event.key === 'K' || event.key === 'ל') {
					noChangeTrainingYes.click();
				} else if (event.key === 'd' || event.key === 'D' || event.key === 'ג') {
					noChangeTrainingNo.click();
				}
			}
    
			// During change training
			if (!changeTrainingYes.disabled) {
				if (event.key === 'k' || event.key === 'K' || event.key === 'ל') {
					changeTrainingYes.click();
				} else if (event.key === 'd' || event.key === 'D' || event.key === 'ג') {
					changeTrainingNo.click();
				}
			}
    
			// During practice trials (we'll add this section when implementing practice trials)
			if (!practiceYes.disabled) {
				if (event.key === 'k' || event.key === 'K' || event.key === 'ל') {
					practiceYes.click();
				} else if (event.key === 'd' || event.key === 'D' || event.key === 'ג') {
					practiceNo.click();
				}
			}
		});
    </script>
</body>
</html>